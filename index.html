<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Time 2 Swim</title>
	<link href="https://fonts.googleapis.com/css?family=Baloo" rel="stylesheet">
	<link rel="shortcut icon" href="htdocs/icon.ico" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<script>
		function openFullscreen() {
		  if (document.body.requestFullscreen) {
			document.body.requestFullscreen();
		  } else if (document.body.mozRequestFullScreen) { /* Firefox */
			document.body.mozRequestFullScreen();
		  } else if (document.body.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
			document.body.webkitRequestFullscreen();
		  } else if (document.body.msRequestFullscreen) { /* IE/Edge */
			document.body.msRequestFullscreen();
		  }
		}
		
		if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
		};
		var was = false;
		function setF(){
			if (gameStarted)
			{
				FX = FISH[PLAYERID][0];
				FY = FISH[PLAYERID][1];
				DIR = FISH[PLAYERID][4];
				SIN = Math.sin(DIR);
				COS = Math.cos(DIR);
				VEL = FISH[PLAYERID][3];
			}
			else
			{
				FX = SCROLLX + WIDTH/2 - 10;
				FY = SCROLLY + HEIGHT/2+65;
				SIN = 0;
				COS = -1;
				VEL = 0.5;
			}
			SIZE = 0.7+3.5*OP;
			type = MYTYPE;
			
			wasR = COLOR.r;
			wasG = COLOR.g;
			wasB = COLOR.b;
			COLOR.r = 0;
			COLOR.g = 57;
			COLOR.b = 100;
			FX += 2;
			FY += 5;
			renderFish(true);
			COLOR.r = wasR;
			COLOR.g = wasG;
			COLOR.b = wasB;
			FX -= 2;
			FY -= 5;
			renderFish(true);
			
			var hai = ele.style.paddingTop;
			var top = +hai.substr(0,hai.length-2)+HEIGHT/2;
			if (dis(MOUSEX+137/SCALE-WIDTH/2,MOUSEY-70/SCALE-HEIGHT/2)<2500)
			{
				C.lineStyle(2,0x999999,OP);
				C.beginFill(0xFFFFFF,OP);
				
				if (LMB && !was)
				{
					MYTYPE = MYTYPE%3+1;
					bubbleSnd.play();
				}
			}
			else
			{
				C.lineStyle(2,0x777777,OP);
				C.beginFill(0xDDDDDD,OP);
			}
			moveTo2(-130+WIDTH/2,top);
			lineTo2(-150+WIDTH/2,30+top);
			lineTo2(-130+WIDTH/2,60+top);
			C.closePath();
			C.endFill();
			
			if (dis(MOUSEX-137/SCALE-WIDTH/2,MOUSEY-70/SCALE-HEIGHT/2)<2500)
			{
				C.lineStyle(2,0x999999,OP);
				C.beginFill(0xFFFFFF,OP);
				
				if (LMB && !was)
				{
					MYTYPE = (MYTYPE+1)%3+1;
					bubbleSnd.play();
				}
			}
			else
			{
				C.lineStyle(2,0x777777,OP);
				C.beginFill(0xDDDDDD,OP);
			}
			moveTo2(130+WIDTH/2,top);
			lineTo2(150+WIDTH/2,30+top);
			lineTo2(130+WIDTH/2,60+top);
			C.closePath();
			C.endFill();
			
			was = LMB;
		};
		var anim = {p: 0, f: 0,d: new Function()};
		function fadeInMenu(){
			anim.d = function(){
				if (anim.p == 1)
				{		
					gameStarted = false;
					justStarted = false;
					getSmaller = 1;
					document.getElementById("lol").style.display = "block";
					document.getElementById('conn').style.visibility = 'hidden';
					highScoreText.text = 'Your highest score: ' + highScore;
					canPlay = true;
				}
				if(anim.p <= 30){
					var much = 40 - Math.cos(anim.p * Math.PI / 60) * 40;
					ele.style.paddingTop = much;
					highScoreText.y = HEIGHT/2+115 + much + LY;
					setAlpha(Math.sin(anim.p * Math.PI / 60));
				}else{
					clearInterval(anim.f);
					anim.p = 0;
				};
				anim.p++;
			};
			anim.f = setInterval(anim.d,16.7);
			document.getElementById('playBtn').innerText = "Play";
		};
		function fadeOutMenu(){
			anim.d = function(){
				if(anim.p <= 30){
					var much = Math.cos(anim.p * Math.PI / 60) * 40;
					ele.style.paddingTop = much;
					highScoreText.y = HEIGHT/2+115 + much + LY
					setAlpha(1 - Math.sin(anim.p * Math.PI / 60));
				} else {
					document.getElementById("lol").style.display = "none";
					clearInterval(anim.f);
					anim.p = 0;
				};
				anim.p++;
			};
			anim.f = setInterval(anim.d,16.7);
		};
		var OP = 1;
		function setAlpha(op)
		{
			OP = op;
			ele.style.opacity = op;
			scoreText.alpha = 1-op;
			scoreMeText.alpha = 1-op;
			hpText.alpha = 1-op;
			o2Text.alpha = 1-op;
			highScoreText.alpha = op;
			chatText.alpha = (1-op) * (CHATACTIVE?0.75:0.25);
			chatMeText.alpha = (1-op) * (CHATACTIVE?0.75:0.25);
			if (diedText.alpha>0) diedText.alpha -= 0.05;
			for (i=0;i<FISH.length;i++) {
				displayNames[i].alpha = 1-op;
			}
		}
	</script>
	<style>
	html:-webkit-full-screen{
		padding: 0;
		margin: 0;
	}
	html:-moz-full-screen{
		padding: 0;
		margin: 0;
	}
	html:-ms-fullscreen{
		padding: 0;
		margin: 0;
	}
	html:fullscreen{
		padding: 0;
		margin: 0;
	}
	body{
		transform-origin: bottom left;
		height:100vw;
		width:100vh;
		background-color: #4477bb;
		padding: 0;
		margin: 0;
		position: relative;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
		overflow: hidden;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		position: fixed;
		z-index: 100500;
	}
	canvas{
		background-color: transparent;
		z-index: -1;
	}
	input:focus, button:focus{
		outline: none;
	}
	.cs{
		width: 14px;
		height: 14px;
		margin: 3px;
		float: left;
		border-radius: 3px;
		padding: 3px;
		box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-webkit-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-moz-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		transition: width 0.3s, height 0.3s, margin 0.3s;
	}
	.cs:hover{
		width: 24px;
		height: 24px;
		margin: -2px;
		cursor: pointer;
	}
	.csH{
		padding: 0px;
		border: 3px white solid;
	}
	.csH:hover{
		border: 3px white solid;
	}
	button,input,select{
		border: 1px black solid;
		height: 40px;
		font-size: 16px;
		box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-webkit-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-moz-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
	}
	input{
		border-radius: 20px 0 0 20px;
		text-indent: 15px;
		font-family: lucida console;
		height: 35px;
		float: left;
		width: 210px;
		margin-left: 10px;
	}
	#playBtn{
		background-color: #59f;
		font-size: 20px;
		border-radius: 0 20px 20px 0;
		margin-left: -6px;
		width: 60px;
		font-family: "Baloo";
		color: white;
		transition: all 0.15s;
		height: 40px;
		padding-top: 3px;
		float: left;
	}
	#playBtn:hover{
		background-color: #6Bf;
	}
	a{
		color: lightBlue;
	}
	.textShadow{
		text-shadow:
			0px -1px 0 rgba(255,255,255,0.7),
			-1px 1px 0 rgba(0,0,0,0.6),
			1px 1px 0 rgba(0,0,0,0.6);
	}
	font{
		color: #3b6;
		position: relative;
		margin-right: -8px;
	}
	#title{
		font-family: Baloo;
		font-size: 58px;
		text-align: center;
		width: 100%;
		font-weight: bold;
	}
</style>
	<script src="socket.io/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.0.0/pixi.min.js"></script>
  </head>
	<body onload="init();" onresize='resize();'>
		<div id="container" align=center>
			<canvas id="game-canvas" width="1000" height="600"></canvas>
			<div id=lol style="padding-top: 40px;background-color:transparent;position:absolute;opacity:1">
				<div id=menu style="padding: 20px; width: 320px; margin-top: 20%;">
					<div id="title" class="textShadow">
						<font id = "f1">A</font>
						<font id = "f2">q</font>
						<font id = "f3">u</font>
						<font id = "f4">a</font>
						<font id = "f5">r</font>
						<font id = "f6">i</font>
						<font id = "f7">o</font>
					</div>
					<br><br>
					<div style="width: 298px;">
						<input type=text id=nickname maxlength="18" placeholder="Your name..."/>
						<button class="textShadow" id=playBtn onclick="startSocket();">Play</button>
						<div style="clear:both"></div>
					</div>
					<div id="conn" style="margin-top:5px; visibility: hidden">Connecting...</div>
					<div id="customize" style="margin-top: 220px; width: 320px;">
						<div class=cs style="background-color: #f00"></div>
						<div class=cs style="background-color: #ff8000"></div>
						<div class=cs style="background-color: #ff0"></div>
						<div class=cs style="background-color: #80ff00"></div>
						<div class=cs style="background-color: #0f0"></div>
						<div class=cs style="background-color: #00ff80"></div>
						<div class=cs style="background-color: #0ff"></div>
						<div class=cs style="background-color: #007fff"></div>
						<div class=cs style="background-color: #00f"></div>
						<div class=cs style="background-color: #7f00ff"></div>
						<div class=cs style="background-color: #f0f"></div>
						<div class=cs style="background-color: #ff0080"></div>
					</div>
					<div style="clear: both"></div>
				</div>
			</div>
			<canvas id="canvasText" width="0" height="0"></canvas>
			<audio src="htdocs/bubble.wav" type="audio/wav" id="bubble">
			<audio src="htdocs/bite.wav" type="audio/wav" id="bite">
			<audio src="htdocs/point.wav" type="audio/wav" id="point">
		</div>
		<script>
		var node = document.getElementById('nickname');
		node.addEventListener('keydown', function onEvent(event) {
			if (event.key === "Enter" && MOUSEX>=0 && MOUSEX<=WIDTH) {
				startSocket();
			}
		});
		
		var COLOR = {r:255,g:0,b:0};
		var MYTYPE = 1+Math.floor(2.99*Math.random());
		
		function heh(col){
			var el = document.getElementsByClassName("csH")[0];
			if (el) el.className = "cs";
			var arel = document.getElementsByClassName("cs");
			for (i=0;i<arel.length;i++){
				if(arel[i].style.backgroundColor != col) continue;
				arel[i].className = "cs csH";
				col = col.substr(4);
				var iu = col.indexOf(',');
				COLOR.r = Math.round(col.substr(0,iu));
				col = col.substr(iu+2);
				iu = col.indexOf(',');
				COLOR.g = Math.round(col.substr(0,iu));
				col = col.substr(iu+2);
				iu = col.indexOf(')');
				COLOR.b = Math.round(col.substr(0,iu));
				setF();
			};
		};
		var arel = document.getElementsByClassName("cs");
		for(i = 0;i < arel.length; i++){
			var col = arel[i].style.backgroundColor;
			arel[i].onclick = new Function("heh('" + col + "');bubbleSnd.play();");
		};
		var ele = document.getElementById("lol");
		
		var letters = [];
		for (i=0;i<7;i++) {
			letters[i] = document.getElementById("f"+(i+1));
		}
		</script>
		<script>
var C, WIDTH, HEIGHT;
var SCROLLX, SCROLLY;
var MOUSEX, MOUSEY, LMB;
var PLANKTON = [];
var TIME = 0;

var boatX = 0;
var boatXTo = 0;
var boatY = 0;
var boatVX = 0;
var boatVA = 0;
var boatTargetX = 0;
//var boatWaitTarget = 0;
//var boatStop = false;
var rodUp = 0;
var hookXTo = 0;
var hookYTo = 0;
var hookX = 0;
var hookY = 0;
var hookVX = 0;
var hookVY = 0;
var veinLen = 0;
var veinStretch = 0;

var PLAYERID = -1;

var BOTTOM = [], BOTTOMSIZE = 50;
/*	[2200,150,500,2,Math.PI,[255,0,100],0,0,"",100,100],
	[2300,200,1,2,1,[0,255,100],0,0,"",100,100],
];*/
var FISH = []; // px,py,size,vel,dir,color,targetDir,boost,nick,hp,stamina
var POSTO = [];
var SHARK = []; // px,py,size,vel,dir,targetDir
var SHARKTO = [];
var BOUNDRIGHT = 7000;

for (i=0;i<10;i++)
{
	FISH.push([0,0,0,0,0,0,0,0,"",0,0,0]);
	POSTO.push([0,0,0,0,0]);
	SHARK.push([0,0,0,0,0,0]);
	SHARKTO.push([0,0,0,0,0]);
}

var type = 1;

var renderer;

var highScore = 0;
var hpText, o2Text, scoreText, scoreMeText, diedText, highScoreText, scoreStyle, chatText, chatMeText;
var HPsmooth = 0;
var O2smooth = 0;

var displayNames = [];

var skywater;

//var points = []; of fish mesh rope

var canvas,contextText;

var bubbleSnd;

function RELOAD()
{
	alert("You've been kicked, you were inactive or the connection was broken.");
	location.reload();
	fadeinMenu();
	setTimeout(null,100000);
}

var container, customize, title;
var vertical = false;
var SCALE = 1;
function resize() {
	// RESPONSIVE LAYOUT !!!!!!! SMALLER LEADERBOARD AND STUFF HP
	/*if (body.scrollHeight > body.offsetHeight) {
		alert("hey");
	}
	console.log(body.scrollHeight+" "+body.offsetHeight+" "+window.innerHeight);
	*/
    WIDTH = window.innerWidth;
    HEIGHT = window.innerHeight;
	
	vertical = (WIDTH<HEIGHT && isMobile);
	if (vertical)
	{
		var temp = HEIGHT;
		HEIGHT = WIDTH;
		WIDTH = temp;
		
		
		document.body.style.transform = "rotate(90deg)";
		document.body.style.top = "-"+(HEIGHT)+"px";
	}
	else
	{
		document.body.style.transform = "rotate(0deg)";
		document.body.style.top = "0";
	}
	
	var minHeight = 400;
	var minWidth = 500;
	var maxHeight = 1000;
	var maxWidth = 1600;

	if (HEIGHT>maxHeight) HEIGHT = maxHeight;
	
	prevWidth = WIDTH;
	prevHeight = HEIGHT;
	if (WIDTH>maxWidth) WIDTH = maxWidth;
	else if (WIDTH<minWidth) WIDTH = minWidth;
	container.marginLeft = Math.floor((prevWidth-WIDTH)*0.5)+"px";
	
	var smaller = HEIGHT;
	if (WIDTH<HEIGHT) smaller = WIDTH;
	SCALE = 600/smaller;
	if (SCALE<1) SCALE = 1;
	
	canvas.width = WIDTH;
	canvas.height = HEIGHT;
	
	this.renderer.resize(WIDTH, HEIGHT);
	
	scoreMeText.x = WIDTH*SCALE-120;
	scoreText.x = WIDTH*SCALE-120;
	
	chatText.x = chatMeText.x = 0.07*WIDTH;
	chatText.y = chatMeText.y = HEIGHT-100;
	
	var conq = canvas.getBoundingClientRect();
	
	if (vertical)
	{
		ele.style.left = Math.round(WIDTH/2-173)+conq.top+"px";
	}
	else
	{
		ele.style.left = Math.round(WIDTH/2-173)+conq.left+"px";
	}
	
	ele.style.top = Math.round(HEIGHT/2-310)+"px";
	
	skywater.width = WIDTH;
	
	diedText.x = WIDTH*SCALE/2;
	diedText.y = HEIGHT*SCALE/2-150;
	
	highScoreText.x = WIDTH*SCALE/2;
	highScoreText.y = HEIGHT*SCALE/2+150;
	
	/*var scale = 0.5;
	document.body.style.transform = 'scale(' + scale + ')';
	document.body.style['-ms-transform'] = 'scale(' + scale + ')';
	document.body.style['-webkit-transform'] = 'scale(' + scale + ')';
	
	window.scrollTo(-2*(1-scale)*prevWidth, 2*(1-scale)*prevHeight);*/
	
	stage.scale.x = stage.scale.y = 1/SCALE;
	
	//WIDTH/=SCALE;
	//HEIGHT/=SCALE;
	
	LX = (SCALE-1)*WIDTH/2;
	LY = (SCALE-1)*HEIGHT/2;
	
	skywater.width = WIDTH*SCALE;
	
	customize.marginTop = (Math.floor(150/SCALE)+50)+"px";
	title.marginBottom = (Math.floor(60/SCALE)-85)+"px";
}

function controlMobile(event,down)
{
	for (i=0;i<event.touches.length;i++)
	{
		var mx = event.touches[i].pageX;
		var my = event.touches[i].pageY;
		if (mx < WIDTH / 2)
			moveMouseTo(mx,my,false);
		else LMB = down;
	}
}

var isMobile = false;
var LX=0,LY=0;
function init() {
	stage = new PIXI.Container();
	if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
		|| /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))
	{ 
		isMobile = true;
		document.body.addEventListener('touchstart', function(event) {controlMobile(event,true);}, false);
		document.body.addEventListener('touchmove', function(event) {controlMobile(event,true);}, false);
		document.body.addEventListener('touchend', function(event) {controlMobile(event,false);}, false);
	}
	container = document.getElementById("container").style;
	customize = document.getElementById("customize").style;
	title = document.getElementById("title").style;
	
	canvas = document.getElementById("game-canvas");
	contextText = document.getElementById("canvasText").getContext('2d');
	
	renderer = PIXI.autoDetectRenderer(WIDTH,HEIGHT,{view:canvas,antialias:true});
	
	window.addEventListener("mousedown", mouseDown);
	window.addEventListener("mouseup", mouseUp);
	window.addEventListener("keydown", keyDown);
	
	bubbleSnd = document.getElementById('bubble');
	biteSnd = document.getElementById('bite');
	pointSnd = document.getElementById('point');
	
	skywater = new PIXI.Sprite(PIXI.Texture.fromImage("htdocs/skywater.png"));
	skywater.position.x = 0;
	skywater.position.y = 0;
	skywater.width = WIDTH*SCALE;
	skywater.height = 3000;//HEIGHT?;
	
	boat = new PIXI.Sprite(PIXI.Texture.fromImage("htdocs/boat.png"));
	boat.anchor.set(0.5,0.5);
	
	man = new PIXI.Sprite(PIXI.Texture.fromImage("htdocs/man.png"));
	man.anchor.set(-0.3,1.2);
	man.scale.x = -1;
	
	C = new PIXI.Graphics();
	
	hpText = new PIXI.Text('HP', {
        fontSize: 20,
        fontFamily: 'Lucida Console',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#888888',
        strokeThickness: 3
    });
	hpText.x = 30;
	hpText.y = 29;
	hpText.alpha = 0;
	
	o2Text = new PIXI.Text('O₂', {
        fontSize: 20,
        fontFamily: 'Lucida Console',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#888888',
        strokeThickness: 3
    });
	o2Text.x = 30;
	o2Text.y = 64;
	o2Text.alpha = 0;
	
	contextText.font = "18px Baloo";

	scoreStyle = new PIXI.TextStyle({
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	
	scoreText = new PIXI.Text('SCORE: 1', scoreStyle);
	scoreText.y = 25;
	scoreText.anchor.set(0.5, 0);
	scoreText.alpha = 0;
	
	scoreMeText = new PIXI.Text('SCORE', {
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFF00',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	scoreMeText.y = 25;
	scoreMeText.anchor.set(0.5, 0);
	scoreMeText.alpha = 0;
	
	diedText = new PIXI.Text('You died', {
        fontSize: 48,
        fontFamily: 'Georgia',
        fill: '#FF0000',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	diedText.anchor.set(0.5, 0);
	diedText.alpha = 0;
	
	highScoreText = new PIXI.Text('', {
        fontSize: 28,
        fontFamily: 'Baloo',
        fill: '#FFFF88',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	highScoreText.anchor.set(0.5, 0);
	highScoreText.alpha = 0;
	
	chatText = new PIXI.Text('', {
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFFFF',
        align: 'left',
        stroke: '#000000',
        strokeThickness: 2,
    });
	chatText.anchor.set(0, 1);
	chatText.alpha = 0;
	
	chatMeText = new PIXI.Text('Press ENTER to chat', {
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFF88',
        align: 'left',
        stroke: '#000000',
        strokeThickness: 2
    });
	chatMeText.anchor.set(0, 0);
	chatMeText.alpha = 0;
	
	stage.addChild(skywater,man,boat,C,hpText,o2Text,scoreText,scoreMeText,diedText,highScoreText,chatText,chatMeText);
	
	for (i=0;i<FISH.length;i++) {
		displayNames[i] = new PIXI.Text('', {
			fontSize: 18,
			fontFamily: 'Baloo',
			fill: '#FFFFFF',
			align: 'center',
			stroke: '#000000',
			strokeThickness: 2,
		});
		displayNames[i].x = 0;
		displayNames[i].y = 0;
		displayNames[i].anchor.set(0.5, 0);
		displayNames[i].alpha = 0;;
		stage.addChild(displayNames[i]);
	}
	
	requestAnimationFrame(update);
	
	//update();
	
	var col = arel[Math.floor((arel.length-0.01)*Math.random())].style.backgroundColor;
	heh(col);
	
	canvas.focus();
	node.focus();
		
	document.getElementById("lol").style.zIndex = 1;
	canvas.style.zIndex = -1;
	document.getElementById("lol").style.position = "absolute";
	
	resize();
	
	//moveTo2 = moveTo;
}

var WIDTH = 1000;
var HEIGHT = 600;
var SCROLLX = 600;
var SCROLLY = -200;
var TIME = 0;

var huntId = -1;

var gameStarted = false;
var justStarted = false;
var getSmaller = 1;
function startGame()
{
	randomizeBottom();
	randomizePlankton();
	
	levelAlert = 0;
	
	MOUSEX = 0;
	MOUSEY = 0;
	
	HPsmooth = 100;
	O2smooth = 100;
	
	deltaTime = 1;
	justStarted = true;
	gameStarted = true;
	getSmaller = 1;
	
	totalLines = 0;
	chatText.text = "";
	chatMeText.text = "Press ENTER to chat";
	CHATACTIVE = false;
	
	boatX = 2000;
	boatY = 5;
	boatVX = 0;
	boatVA = 0;
	boatTargetX = 3000;
	//boatStop = true;
	
	man.scale.x = (boatVX>0?-1:1);
	huntId = -1;
	
	boatX = boatXTo;
	hookX = hookXTo;
	hookY = hookYTo;
	
	fadeOutMenu();
	//loop();
	canvas.focus();
	
	LMB = false;
}

function getSize(s)
{
	return 0.7*Math.pow(s,0.35);
}

var lastTime = 0;
var levelAlert = 0;
var deltaTime = 1;
var SOFT = 0;
var lastUpdate = 0;
function update(time)
{
	TIME = time/15;
	
	window.scrollTo(0,0);
	
    if (lastTime) {
        deltaTime = deltaTime*0.5+(time - lastTime)/33.4;
		if (deltaTime>3) deltaTime = 3;
    }
    lastTime = time;
	
	C.clear();
	
	input();
	
	if (gameStarted)
	{
		if (justStarted)
		{
			SCROLLX = POSTO[PLAYERID][0]-WIDTH/2;
			SCROLLY = POSTO[PLAYERID][1]-HEIGHT/2-65;
			SOFT = 0;
			justStarted = false;
			lastUpdate = TIME;
		}
		else
		{
			SOFT = Math.pow(0.9,deltaTime);
			control();
			
			if (POSTO[PLAYERID][0]==0 || TIME-lastUpdate>300)
			{
				RELOAD();
			}
		}
		
		skywater.y = -1180-SCROLLY+LY;
		
		renderPlankton();
		moveBoat();
		
		var len = 270 + 80 * Math.sin(TIME*0.01);
		var shift = 150 + 80 * Math.sin(TIME*0.003427);
		
		for (i=0;i<SHARK.length;i++)
		{
			if (!SHARK[i] || SHARKTO[i][0]==0) continue;
			
			var fish = SHARK[i];
			var vel = fish[3];
			var dir = fish[4];
			FX = fish[0];
			FY = fish[1];
			SIN = Math.sin(dir);
			COS = Math.cos(dir);
			SIZE = fish[2];
			VEL = fish[3];
			var mouthX = FX + COS*SIZE*18;
			var mouthY = FY + SIN*SIZE*18;
			
			SHARKTO[i][0] += VEL*COS*deltaTime;
			SHARKTO[i][1] += VEL*SIN*deltaTime;			
			SHARK[i][0] = FX * SOFT + SHARKTO[i][0] * (1-SOFT);
			SHARK[i][1] = FY * SOFT + SHARKTO[i][1] * (1-SOFT);
			//SHARK[i][0] = (FX + vel*COS*deltaTime) * SOFT + SHARKTO[i][0] * (1-SOFT);
			//SHARK[i][1] = (FY + vel*SIN*deltaTime) * SOFT + SHARKTO[i][1] * (1-SOFT);
			SHARK[i][3] = VEL * SOFT + SHARKTO[i][2] * (1-SOFT);
			SHARK[i][4] = dir * SOFT + SHARKTO[i][3] * (1-SOFT);
			SHARK[i][5] = SHARK[i][5] * SOFT + SHARKTO[i][4] * (1-SOFT);
						
			if (FY > SIZE * 5.9)
			{
				var turn = (mod(SHARK[i][5]+Math.PI-dir,2*Math.PI)-Math.PI);
				if (turn>1) turn = 1;
				if (turn<-1) turn = -1;
				
				SHARK[i][4] += deltaTime*turn/(10+10*SIZE);
			}
			
			var how = mod(FX/BOTTOMSIZE,1);
			var le = BOTTOM[Math.floor(FX/BOTTOMSIZE)];
			var ri = BOTTOM[Math.ceil(FX/BOTTOMSIZE)];
			var bottom = le*(1-how) + ri*how - SIZE * 6;
			if (FY > bottom)
			{
				var much = (FY - bottom)*0.3;
				SHARKTO[i][2] *= 1-0.01*much*deltaTime;
				SHARKTO[i][0] += much * (ri-le)/BOTTOMSIZE * deltaTime;
				SHARKTO[i][1] -= much * deltaTime;
				
				much = SIZE * 3 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					SHARKTO[i][3] += SIN * (COS<0?1:-1) * 0.02 * much * deltaTime;
					SHARKTO[i][2] *= 1 - 0.03*deltaTime;
				}
			}
			else if (FY < SIZE * 3)
			{
				much = SIZE * 3 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					SHARKTO[i][3] += much * (COS>0?0.01:-0.01)/(Math.abs(VEL)+0.1) * deltaTime;
					SHARKTO[i][2] += much * SIN * 0.025 * deltaTime;
				}
			}
			else SHARK[i][3] = SHARK[i][3]*(1-0.1*deltaTime) + 0.25*deltaTime;
			
			var mx = FX-SCROLLX;
			var my = FY-SCROLLY;
			if (mx+LX>-30*SIZE && mx+LX<WIDTH*SCALE+30*SIZE && my+LY>-30*SIZE && my+LY<HEIGHT*SCALE+30*SIZE) renderShark();
		}
		
		for (i=0;i<FISH.length;i++)
		{
			if (!FISH[i] || !POSTO[i] || POSTO[i][0]==0)
			{
				//alert(FISH.length+" hey");
				displayNames[i].y = -100;
				continue;
			}
			//else alert(FISH.length+" nope");
			
			var fish = FISH[i];
			var dir = fish[4];
			FX = fish[0];
			FY = fish[1];
			SIN = Math.sin(dir);
			COS = Math.cos(dir);
			SIZE = getSize(fish[2]);
			VEL = fish[3];
			col = fish[5];
			COLOR.b = col%256;
			col = (col - COLOR.b)/256;
			COLOR.g = col%256;
			col = (col - COLOR.g)/256;
			COLOR.r = col%256;
			
			if (FISH[i][9]>0 && huntId != i)
			{
				POSTO[i][0] += VEL*COS*deltaTime;
				POSTO[i][1] += VEL*SIN*deltaTime;
			}
			/*FISH[i][0] = (FX + VEL*COS*deltaTime) * SOFT + POSTO[i][0] * (1-SOFT);
			FISH[i][1] = (FY + VEL*SIN*deltaTime) * SOFT + POSTO[i][1] * (1-SOFT);*/
			FISH[i][0] = FX * SOFT + POSTO[i][0] * (1-SOFT);
			FISH[i][1] = FY * SOFT + POSTO[i][1] * (1-SOFT);
			FISH[i][3] = VEL * SOFT + POSTO[i][2] * (1-SOFT);
			FISH[i][4] = dir * SOFT + POSTO[i][3] * (1-SOFT);
			FISH[i][2] = fish[2] * SOFT + POSTO[i][4] * (1-SOFT);
			
			var mouthX = FX + COS*SIZE*18;
			var mouthY = FY + SIN*SIZE*18;
			
			if (getSmaller<0.99 && i==PLAYERID)
			{
				if (diedText.alpha<1) diedText.alpha += 0.05;
				SIZE*=getSmaller;
				getSmaller-=0.1;
				if (getSmaller<=0) continue;
			}
			
			for (a=0;a<PLANKTON.length;a++)
			{
				var px = PLANKTON[a][0];
				px += 5*Math.sin(px*0.01+TIME*0.05);
				if (dis(px-mouthX,PLANKTON[a][1]-mouthY) < SIZE*SIZE*250+20)
				{
					if (PLANKTON[a][2] == 0)
						socket.emit("tasty");
					else
						socket.emit("yummy");
						
					pointSnd.play();
					
					var x = Math.random()*(BOUNDRIGHT-2800)+1400;
					if (x-SCROLLX>-10 && x-SCROLLX<WIDTH+10)
					{
						if (SCROLLX<BOUNDRIGHT/2) x+=2500;
						else x-=2500;
					}
					
					var le = BOTTOM[Math.floor(x/BOTTOMSIZE)];
					var ri = BOTTOM[Math.ceil(x/BOTTOMSIZE)];
					if (le<ri) ri = le;
					
					var y = Math.random() * (ri-100) + 50;
					
					PLANKTON[a]=[x,y];
				}
			}
			
			if (FY > SIZE * 5.9)
			{
				var turn = (mod(FISH[i][6]-dir,2*Math.PI)-Math.PI)*2.61/VEL;
				if (turn>1) turn = 1;
				if (turn<-1) turn = -1;
				
				POSTO[i][3] += deltaTime*turn/(10+2*SIZE);
				
				if (FISH[i][7] && FISH[i][10]>0.5)
				{
					POSTO[i][2] += 0.25;
					FISH[i][10] -= 0.5;
				}
			}
			FISH[i][10] += 0.1;
			if (FISH[i][10]>100) FISH[i][10] = 100;
			
			var how = mod(FX/BOTTOMSIZE,1);
			var le = BOTTOM[Math.floor(FX/BOTTOMSIZE)];
			var ri = BOTTOM[Math.ceil(FX/BOTTOMSIZE)];
			var bottom = le*(1-how) + ri*how - SIZE * 19;
			if (FY > bottom)
			{
				var much = (FY - bottom)*0.6;
				POSTO[i][2] *= 1-0.01*much*deltaTime;
				POSTO[i][0] += much * (ri-le)/BOTTOMSIZE * deltaTime;
				POSTO[i][1] -= much * deltaTime;
				
				much = SIZE * 6 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					POSTO[i][3] += SIN * (COS<0?1:-1) * 0.02 * much;
					POSTO[i][2] *= 1 - 0.03*deltaTime;
					FISH[i][9] -= 0.5 * deltaTime;
				}
			}
			else if (FY < SIZE * 6)
			{
				much = SIZE * 6 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					POSTO[i][3] += much * (COS>0?0.02:-0.02)/(Math.abs(VEL)+0.1) * deltaTime;
					POSTO[i][2] += much * SIN * 0.025 * deltaTime;
					POSTO[i][0] += 0.1;
				}
			}
			else FISH[i][3] = FISH[i][3]*0.9 + 0.25;
			
			if (FISH[i][9]<=0)
			{
				POSTO[i][2] = 0;
				FISH[i][9] = 0;
			}
			
			var mx = FX-SCROLLX;
			var my = FY-SCROLLY;
			if (mx+LX>-25*SIZE-20 && mx+LX<WIDTH*SCALE+25*SIZE+20)
			{
				if (my+LY>-25*SIZE && my+LY<HEIGHT*SCALE+25*SIZE)
				{
					type = FISH[i][11];
					renderFish(false);
				}
				
				my = FY-SIZE*33-30-SCROLLY;
				if (my+LX>-25*SIZE && my+LY<HEIGHT*SCALE+25*SIZE)
				{
					displayNames[i].x = LX + mx;
					displayNames[i].y = LY + my;
					displayNames[i].text = FISH[i][8];
				}
				else displayNames[i].y = -100;
			}
			else displayNames[i].y = -100;
			
			//FX = POSTO[i][0]; FY = POSTO[i][1];	renderFish(false);
					
			//FX -= COS*10*VEL; FY -= SIN*10*VEL; renderFish(false);
			
			//for (p=0;p<100;p++) {renderFish(false);FX+=25;if (FX>SCROLLX+800) {FX = SCROLLX+200; FY+=25;}}
		}
		
		if (OP>0.05) setF();
		
		renderWater();
		renderBottom();
		renderGreenShit();
		
		face();
		
		sendPlayerData();
	}
	else
	{
		for (i=0;i<7;i++) {
			letters[i].style.top = Math.round(11*Math.sin(TIME*0.04+i*0.7))+"px";
		}
		setF();
	}
	
	renderer.render(stage);
	
    requestAnimationFrame(update);

	//setTimeout(update,1000/6000);
}

function moveBoat()
{
	hookX = hookX * 0.7 + hookXTo * 0.3;
	hookY = hookY * 0.7 + hookYTo * 0.3;
	
	var vx = Math.cos(TIME*0.07)*boatVX;
	var vy = Math.sin(TIME*0.07)*Math.abs(boatVX);
	
	var high = Math.atan(rodUp-6);
	
	var tox = boatX-man.scale.x*(65-(high+1.2)*(high+1.2)*2);
	var toy = boatY-50-20*high;
	
	if (veinLen==0)
	{
		hookX = tox;
		hookY = toy;
	}
	var hx = hookX-SCROLLX;
	var hy = hookY-SCROLLY;
	
	boatX = boatX * SOFT + boatXTo * (1-SOFT);
	
	if (Math.abs(boatX-boatTargetX)<100)
	{
		if (veinLen>0)
		{
			hookXTo += hookVX;
			hookYTo += hookVY;
			
			hookVY += 0.2;
			
			if (hookY>0)
			{
				hookVY *= 0.99;
			}
			
			var vex = hookX-tox;
			var vey = hookY-toy;
			
			var len = Math.sqrt(vex*vex+vey*vey);
			var distance = veinLen-len;
			
			if (distance<0)
			{
				hookVX *=0.95;
				hookVY *=0.95;
				hookXTo += 0.3*vex/len*distance;
				hookYTo += 0.3*vey/len*distance;
			}
			
			if (distance<3)
			{
				if (veinLen<340 && veinStretch>0 || veinStretch>40) veinStretch -=4;
			}
			else if (veinStretch<80) veinStretch += 4;
		}
	}
	else
	{
		if (boatX<boatTargetX)
		{
			boatVX+=0.04;
		}
		else
		{
			boatVX-=0.04;
		}
	}
	if (boatVX>0)
	{
		if (man.scale.x>-1) man.scale.x -= 0.1;
	}
	else
	{
		if (man.scale.x<1) man.scale.x += 0.1;
	}
	
	boatVX *= 0.98;

	boatX += boatVX;
	boatVA += Math.sin(TIME*0.05)*0.0002 - Math.sin(boat.rotation) * 0.01 - boatVX * 0.0001;
	boatVA *= 0.9;
	
	man.x = boat.x = LX + boatX - SCROLLX;
	man.y = boat.y = LY + boatY - SCROLLY;
	boat.rotation += boatVA;
	
	C.lineStyle(9,0xd6ae77);
	moveTo2(boat.x-LX+16*man.scale.x,boat.y-LY-23);
	lineTo2(boat.x-LX-vx*5,boat.y-LY-30-vy*1.5);
	C.lineStyle(5,0x884400);
	lineTo2(boat.x-LX+vx*20,boat.y-LY+vy*6);
	C.lineStyle(12,0x884400);
	lineTo2(boat.x-LX+vx*30,boat.y-LY+10+vy*9);
	
	C.lineStyle(4,0x224422);
	moveTo2(boat.x-LX+man.scale.x*12,boat.y-LY-25);
	lineTo2(tox-SCROLLX,toy-SCROLLY);
	
	C.lineStyle(2,0x774422);
	quadraticCurveTo2(tox-SCROLLX,toy+veinStretch-SCROLLY,hx,hy);
	
	C.lineStyle(5,0xAAAAAA);
	if (man.scale.x>0) arc2(hx, hy+20, 10, 0, 3.14);
	else arc2(hx, hy+20, 10, 3.14, 0, true);
}

function drawCircle2(a,b,c){
	C.drawCircle(a+LX,b+LY,c);
}

function arc2(a,b,c,d,e,hey){
	C.arc(a+LX,b+LY,c,d,e,hey);
}

function moveTo2(t,e){
	C.moveTo(t+LX,e+LY);
}

function lineTo2(t,e){
	C.lineTo(t+LX,e+LY);
}

function bezierCurveTo2(a,b,c,d,e,f){
	C.bezierCurveTo(a+LX,b+LY,c+LX,d+LY,e+LX,f+LY);
}

function quadraticCurveTo2(a,b,c,d){
	C.quadraticCurveTo(a+LX,b+LY,c+LX,d+LY);
}

function compareNumbers(a, b) {
   return b[1] - a[1];
}

var listOnce = 0;
function face()
{
	HPsmooth = HPsmooth*0.8 + FISH[PLAYERID][9]*0.2;
	O2smooth = O2smooth*0.8 + FISH[PLAYERID][10]*0.2;
	
	C.lineStyle(2, 0x440000);
	C.beginFill(0x880000, 0.6);
	C.drawRoundedRect(25, 27, 120, 26, 10);
	C.endFill();
	
	if (HPsmooth>0.1)
	{
		var edge = 10;
		if (0.6*HPsmooth<10) edge = 0.6*HPsmooth;
		C.lineStyle(null);
		C.beginFill(0xFF2222, 0.6);
		C.drawRoundedRect(25, 32-edge*0.5, 1.2*HPsmooth, 16+edge, edge);
		C.endFill();
	}
	
	C.lineStyle(2, 0x225588);
	C.beginFill(0x3366AA, 0.6);
	C.drawRoundedRect(25, 62, 120, 26, 10);
	C.endFill();
	
	if (O2smooth>0.1)
	{
		var edge = 10;
		if (0.6*O2smooth<10) edge = 0.6*O2smooth;
		C.lineStyle(null);
		C.beginFill(0x55BBFF, 0.6);
		C.drawRoundedRect(25, 67-edge*0.5, 1.2*O2smooth, 16+edge, edge);
		C.endFill();
	}
	
	C.beginFill(0x000000,0.3);
	C.drawRoundedRect(WIDTH*SCALE-230,15,220,250,10);
	C.endFill();
	
	if (listOnce > 100)
	{
		listOnce = 0;
	}
	else
	{
		listOnce++;
	
		var list = [];
		for (i=0;i<FISH.length;i++)
		{
			if (POSTO[i][0] == 0) continue;
			
			var currSc = Math.round(FISH[i][2] * 10);
			if (i==PLAYERID)
			{
				if (currSc > highScore) highScore = currSc;
				currSc += 0.5;
			}
			if (currSc>0) list.push([FISH[i][8],currSc]);
		}
		list.sort(compareNumbers);
		
		var name = FISH[PLAYERID][8];
		
		var nr = 0;
		for (i=0;i<list.length;i++)
		{
			if (list[i][0] == name)
			{
				nr = i;
				break;
			}
		}
		
		var a = 9;
		
		var print = "⁌LEADERBOARD⁍";
		var print2 = "";
		for (i=0;i<list.length && i<a;i++)
		{
			if (nr>=a && i==a-2)
			{
				print += "\n...";
				print += "\n" + (nr+1) + ". " + name + " - " + Math.floor(list[nr][1]);
				print2 += "\n\n" + (nr+1) + ". " + name + " - " + Math.floor(list[nr][1]);
				break;
			}
			else
			{
				var left = (i+1) + ". " + list[i][0];
				var right = " - " + Math.floor(list[i][1]);
				
				var ri = contextText.measureText(right).width;
				var le = contextText.measureText(left).width;
				while (le + ri > 200 && left.length>5)
				{
					left = left.substr(0,left.length-1);
					le = contextText.measureText(left).width;
				}
				
				if (list[i][0] == name) print2 += "\n" + left + right;
				else print2 += "\n";
				print += "\n" + left + right;
			}
		}
		if (a<list.length && list.length>nr) print += "\n...";
		scoreText.text = print;
		scoreMeText.text = print2;
	}
	
	C.beginFill(0x000000,0.2);
	C.arc(80,HEIGHT-80,70,0,2*Math.PI);
	C.drawRoundedRect(WIDTH-150,HEIGHT-150,140,140,30);
	C.endFill();
	
	C.beginFill(0xFFFFFF,0);
	C.lineStyle(5+2*LMB,0xFFFFFF,0.4+0.2*LMB);
	C.moveTo(WIDTH-120,HEIGHT-80);
	C.lineTo(WIDTH-40,HEIGHT-80);
	C.moveTo(WIDTH-80,HEIGHT-120);
	C.lineTo(WIDTH-80,HEIGHT-40);
	C.endFill();
	
	C.beginFill(0xFFFFFF,0);
	C.lineStyle(10,0xCCCCCC,0.5);
	C.moveTo(80,HEIGHT-80);
	C.lineTo(MOUSEX,MOUSEY);
	C.endFill();
	
	C.beginFill(0xFFFFFF,1);
	C.lineStyle(0,0xCCCCCC,0.7);
	C.moveTo(MOUSEX-10,MOUSEY);
	C.arc(MOUSEX,MOUSEY,10,0,2*Math.PI);
	C.endFill();
}

var joyx = 0;
var joyy = 0;

function rgbToHex(r, g, b) {
    return "0x"+(((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1));
}

function renderFish(myFishCover)
{
	var colorOut = rgbToHex(Math.round(COLOR.r*0.8),Math.round(COLOR.g*0.8),Math.round(COLOR.b*0.8));
	var colorIn = rgbToHex(COLOR.r,COLOR.g,COLOR.b);
	
	var tirl = VEL*0.8*Math.cos(0.15*TIME);
	var twirl = VEL*1.5*Math.sin(0.15*TIME);
	var yummy = 3.5*Math.sin(0.1*TIME);
	
	if (myFishCover && OP > 0)
	{
		yummy = 0;
		
		if (COLOR.r+COLOR.g+COLOR.b == 157)
		{
			C.lineStyle(null);
			C.beginFill(0x006699,Math.round(OP*10)/10);
			C.drawRect(0,0,WIDTH*SCALE,HEIGHT*SCALE);
			C.endFill();
		}
	}
	
	C.lineStyle(null);
	C.beginFill(colorOut);
	
	if (type == 1)
	{
		swirlRot2(18,twirl*0.5,true);
		swirlRot2(31-0.2*twirl,-15-tirl);
		swirlRot2(29+0.2*twirl,15-tirl);
	}
	else if (type == 2)
	{
		swirlRot2(18,twirl*0.5,true);
		swirlRot2(29-0.2*twirl,-14-tirl);
		swirlRot2(33,0);
		swirlRot2(28+0.2*twirl,14-tirl);
	}
	else
	{
		swirlRot2(16,twirl*0.5,true);
		swirlRot2(33-0.2*twirl,-15-tirl);
		swirlRot2(27,3);
		swirlRot2(30+0.2*twirl,15-tirl);
	}
	
	C.closePath();
	C.endFill();
	
	C.beginFill(colorOut);
	
	if (type == 1)
	{
		swirlRot2(-8,-12,true);
		swirlRot2(-8,12);
		swirlRot2(9-0.5*tirl,21+0.5*twirl);
		swirlRot2(4,0);
		swirlRot2(8+0.5*tirl,-22+0.5*twirl);
	}
	else if (type == 2)
	{
		swirlRot2(-8,-17+0.15*twirl,true);
		swirlRot2(-12,0);
		swirlRot2(-8,17-0.15*twirl);
		swirlRot2(9-0.5*tirl,19+0.5*twirl);
		swirlRot2(4,0);
		swirlRot2(8+0.5*tirl,-19+0.5*twirl);
	}
	else
	{
		swirlRot2(-10,-12,true);
		swirlRot2(-12,0);
		swirlRot2(-10,12);
		swirlRot2(5-0.5*tirl,22+0.5*twirl);
		swirlRot2(18,0);
		swirlRot2(4+0.5*tirl,-22+0.5*twirl);
	}
	
	C.closePath();
	C.endFill();
	
	var pl = swirlPoint2(-24,1-tirl);
	var plmo = swirlPoint2(-24,6-yummy-tirl);
	var plmi = swirlPoint2(-10-type,3-tirl*0.5);
	var pr = swirlPoint2(24,twirl*0.5);
	var plu = swirlPoint2(-24+type*2,-24-twirl);
	var pld = swirlPoint2(-18+type*2,23-twirl);
	var pru = swirlPoint2(22-type*3,-18+twirl-type*2);
	var prd = swirlPoint2(15,19+twirl);
	var peye;
	if (type == 1) peye = swirlPoint2(-14,-7-twirl*0.25);
	else if (type == 2) peye = swirlPoint2(-11,-7-twirl*0.25);
	else peye = swirlPoint2(-13,-4-twirl*0.25);
	
	C.beginFill(colorIn)
	moveTo2(pl[0],pl[1]);
	bezierCurveTo2(plu[0],plu[1],pru[0],pru[1],pr[0],pr[1]);
	bezierCurveTo2(prd[0],prd[1],pld[0],pld[1],plmo[0],plmo[1]);
	lineTo2(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.lineStyle(SIZE*2.5,0xffffff);
	C.beginFill(0x000000);
	drawCircle2(peye[0],peye[1],SIZE*(4.5-0.5*type));
	C.endFill();
}

function renderShark()
{
	C.lineStyle(null);
	C.beginFill(0x788F96);
	
	var tirl = VEL*0.5*Math.cos(0.15*TIME);
	var twirl = VEL*Math.sin(0.15*TIME);
	var yummy = 1.75*Math.sin(0.1*TIME);
	
	swirlRot2(18,twirl*0.5,true);
	swirlRot2(31-0.2*twirl,-7.5-tirl);
	swirlRot2(29+0.2*twirl,7.5-tirl);
	
	C.closePath();
	C.endFill();
	C.beginFill(0x788F96);
	
	swirlRot2(-21,-0.5,true);
	swirlRot2(9-0.5*tirl,10.5+0.5*twirl);
	swirlRot2(7,4);
	swirlRot2(8+0.5*tirl,-11+0.5*twirl);
	
	C.closePath();
	C.endFill();
		
	C.beginFill(0x89A4AD);
	
	var pl = swirlPoint2(-24,0.5-tirl);
	var plmo = swirlPoint2(-24,3-yummy-tirl);
	var plmi = swirlPoint2(-12,1.5-tirl*0.5);
	var pr = swirlPoint2(24,twirl*0.5);
	var plu = swirlPoint2(-20,-12-twirl);
	var pld = swirlPoint2(-20,9.5-twirl);
	var pru = swirlPoint2(20,-10+twirl);
	var prd = swirlPoint2(15,9+twirl);
	var peye = swirlPoint2(-14,-3.5-twirl*0.25);
	moveTo2(pl[0],pl[1]);
	bezierCurveTo2(plu[0],plu[1],pru[0],pru[1],pr[0],pr[1]);
	lineTo2(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.beginFill(0xDDDDEE);
	moveTo2(pr[0],pr[1]);
	bezierCurveTo2(prd[0],prd[1],pld[0],pld[1],plmo[0],plmo[1]);
	lineTo2(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.beginFill(0x000000);
	C.lineStyle(SIZE*1.75,0xffffff);
	drawCircle2(peye[0],peye[1],SIZE*2);
	C.endFill();
}

function swirlRot2(x,y,first)
{
	if (COS>0) y = -y;
	x*=SIZE;
	y*=SIZE;
	if (first) moveTo2(FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY);
	else lineTo2(FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY);
}

function swirlPoint2(x,y)
{
	if (COS>0) y = -y;
	x*=SIZE;
	y*=SIZE;
	return [FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY];
}

function control()
{
	var x = FISH[PLAYERID][0];
	var y = FISH[PLAYERID][1];
	//var x = POSTO[PLAYERID][0];
	//var y = POSTO[PLAYERID][1];
	
	//var SOFT = deltaTime*0.03;
	if (SOFT==0) return;
	
	//SOFT = 0.95;//(1-OP);
	
	if (isMobile)
	{
		SCROLLX = SCROLLX * SOFT + (2 * (MOUSEX-80) - 0.5 * WIDTH + x) * (1-SOFT);
		SCROLLY = SCROLLY * SOFT + (2 * (MOUSEY-HEIGHT+80) - 0.5 * HEIGHT + y) * (1-SOFT);
	}
	else
	{
		SCROLLX = SCROLLX * SOFT + (0.5 * MOUSEX - 0.75 * WIDTH + x) * (1-SOFT);
		SCROLLY = SCROLLY * SOFT + (0.5 * MOUSEY - 0.75 * HEIGHT + y) * (1-SOFT);
	}
	
	if (SCROLLX<0) SCROLLX = 0;
	if (SCROLLX>BOUNDRIGHT-WIDTH) SCROLLX = BOUNDRIGHT-WIDTH;
	
	if (isMobile) FISH[PLAYERID][6] = -Math.PI/2-Math.atan2(MOUSEX-80,MOUSEY-HEIGHT+80);
	else FISH[PLAYERID][6] = -Math.PI/2-Math.atan2(MOUSEX+SCROLLX-x,MOUSEY+SCROLLY-y);
	
	FISH[PLAYERID][7] = LMB;
}

function renderBottom()
{
	C.lineStyle(2, 0x6E652B);
	C.beginFill(0x817639);
	
	moveTo2(-LX,2*HEIGHT*SCALE);
	
	for (x=-Math.ceil(LX/BOTTOMSIZE);x<WIDTH*SCALE/BOTTOMSIZE+2;x++)
	{
		lineTo2(x*BOTTOMSIZE-mod(SCROLLX,BOTTOMSIZE),BOTTOM[x+Math.floor(SCROLLX/BOTTOMSIZE)]-SCROLLY);
	}
	
	lineTo2(WIDTH*SCALE-LX,2*HEIGHT);
	C.endFill();
}

function renderGreenShit()
{
	//C.beginFill(0x118833);
	
	for (x=-Math.ceil(LX/BOTTOMSIZE);x<WIDTH*SCALE/BOTTOMSIZE+2;x++)
	{
		var which = x+Math.floor(SCROLLX/BOTTOMSIZE);
		var type = (2*which+which%11-which%5)%16;
		if (which<30 || which>BOUNDRIGHT/BOTTOMSIZE-30 || type>3) continue;
		
		var mx = x*BOTTOMSIZE-mod(SCROLLX,BOTTOMSIZE);
		var my = BOTTOM[which]-SCROLLY;
		
		if (type < 2)
		{
			var shift = TIME*0.05+(mx+SCROLLX)*0.01;
			C.lineStyle(5, 0x005522);
			moveTo2(mx,my);
			var sy = my-20-which%7;
			var nd = mx+Math.sin(shift)*3;
			lineTo2(nd,sy);
			lineTo2(mx+Math.sin(shift+0.3)*7-(type==1?9:5)-which%3,sy-20-(which+3)%7);
			
			if (type == 1)
			{
				lineTo2(nd,sy);
				lineTo2(mx+Math.sin(shift)*7+2-(which+1)%2,sy-23-which%5);
			}
			
			lineTo2(nd,sy);
			lineTo2(mx+Math.sin(shift-0.3)*7+(type==1?14:10)-(which+2)%3,sy-20-which%7);
		}
		else if (type < 4)
		{
			C.beginFill(0x446677);
			//C.beginFill(0xAA3366);
			C.lineStyle(2, 0x335566);
			//C.lineStyle(5, 0x882244);
			w = 4+(which*3)%7;
			h = w-which%3;
			C.drawRoundedRect(mx-w+LX,my-h*1.5+LY,2*w,2*h,h-1);
			C.endFill();
		}
	}
	
	//C.endFill();
}

function input()
{
	if (getSmaller<0.99) return;
	var mousePosition = renderer.plugins.interaction.mouse.global;
	
	if (!isMobile)
	{
		moveMouseTo(mousePosition.x,mousePosition.y);
	}
}

function moveMouseTo(px,py,click)
{
	if (vertical)
	{
		if (isMobile)
		{
			MOUSEY = window.innerWidth-px;
			MOUSEX = py;
		}
		else
		{
			var off = (WIDTH-HEIGHT)/2;
			MOUSEY = WIDTH-px-off;
			MOUSEX = py+off;
		}
	}
	else
	{	
		MOUSEX = px;
		MOUSEY = py;
	}
	if (click && !gameStarted) LMB = true;
	
	if (isMobile)
	{	
		var vx = MOUSEX - 80;
		var vy = MOUSEY - HEIGHT + 80;
		
		var len = Math.sqrt(vx*vx+vy*vy);
		if (len>70)
		{
			MOUSEX += vx*(70-len)/len;
			MOUSEY += vy*(70-len)/len;
		}
	}
}

function mouseDown(e)
{
	if (e.button == 0) LMB = true;
}

function mouseUp(e)
{
	if (e.button == 0) LMB = false;
}

var CHATACTIVE = false;
function keyDown(e)
{
	if (!gameStarted) return;
	
	var keyCode = e.which || e.keyCode || 0;
	var len = chatMeText.text.length;
	if (keyCode == 8)
	{
		if (len>4) chatMeText.text = chatMeText.text.substr(0,len-1);
	}
	else if (keyCode == 13)
	{
		if (CHATACTIVE)
		{
			chatText.alpha = 0.25;
			chatMeText.alpha = 0.25;
			CHATACTIVE = false;
			
			if (chatMeText.text.length>4)
			{
				socket.emit("chat",chatMeText.text.substr(4));
			}
			chatMeText.text = "Press ENTER to chat";
		}
		else
		{
			chatText.alpha = 0.75;
			chatMeText.alpha = 0.75;
			CHATACTIVE = true;
			
			chatMeText.text = "Me: ";
		}
	}
	else if (CHATACTIVE && keyCode>=32 && e.key.length == 1 && e.keyCode!=220 && len<70)
	{
		chatMeText.text += e.key;
	}
}

function dis(dx,dy)
{
	return dx*dx+dy*dy;
}

function squared(n)
{
	return n*n;
}

function renderWater()
{
	C.lineStyle(3, 0xFFFFFF, 0.1);
	C.beginFill(0x006699, 0.4);
	
	moveTo2(-LX,HEIGHT*SCALE);
	
	for (x=-2-LX;x<WIDTH*SCALE+15;x+=15)
	{
		lineTo2(x,2*Math.sin(0.1*(x+SCROLLX+TIME))-SCROLLY);
	}
	lineTo2(WIDTH*SCALE,HEIGHT*SCALE);
	C.endFill();
}

function randomizeBottom()
{
	BOTTOM = [];
	MAPWIDTH = 250;
	MAPHEIGHT = 100;
	
	BOTTOM = [Math.random()-0.5];
	
	var vel = 0;
	for (x=1;x<BOUNDRIGHT/BOTTOMSIZE+2;x++)
	{
		vel = 0.99*vel + pseudoRandom(x);
		BOTTOM.push((BOTTOM[x-1] + vel) * 0.5);
	}
	
	for (x=0;x<BOTTOM.length;x++)
	{
		BOTTOM[x] = (BOTTOM[x]*20+350)*(Math.atan((x*BOTTOMSIZE-1500)/200)-Math.atan((x*BOTTOMSIZE+1500-BOUNDRIGHT)/200))-80;
	}
}

function pseudoRandom(i)
{
	return Math.abs(23*Math.sin(BOTTOMKEY*i+273*i)+23*Math.tan(BOTTOMKEY*i*(0.2-3*i)))%1-0.5;
}

function randomizePlankton()
{
	PLANKTON = [];
	
	var extra = 0;
	for (x=1400;x<BOUNDRIGHT-1400;x+=150)
	{
		var le = BOTTOM[Math.floor(x/BOTTOMSIZE)];
		var ri = BOTTOM[Math.ceil(x/BOTTOMSIZE)];
		if (le<ri) ri = le;
		
		var y = Math.random() * (ri-100) + 50;
		
		var type = 0;
		
		extra++;
		if (extra>10)
		{
			extra = 0;
			type = 1;
		}
		
		PLANKTON.push([x+Math.random()*20-10,y+Math.random()*20-10,type]);
	}
}

function renderPlankton()
{
	C.lineStyle(2, 0x227744);
	C.beginFill(0x339955);
	for (i=0;i<PLANKTON.length;i++)
	{
		if (PLANKTON[i][2] != 0) continue;
		var px = PLANKTON[i][0];
		px += 5*Math.sin(px*0.01+TIME*0.05);
		var mx = px-SCROLLX;
		var my = PLANKTON[i][1]-SCROLLY;
		if (mx+LX>-10 && mx+LX<WIDTH*SCALE+10 && my+LY>-10 && my+LY<HEIGHT*SCALE+10)
			drawCircle2(mx,my,6+i%3);
	}
	C.endFill();
	
	C.lineStyle(2, 0x99CC22);
	C.beginFill(0xAAEE33);
	for (i=0;i<PLANKTON.length;i++)
	{
		if (PLANKTON[i][2] != 1) continue;
		var px = PLANKTON[i][0];
		px += 5*Math.sin(px*0.01+TIME*0.05);
		var mx = px-SCROLLX;
		var my = PLANKTON[i][1]-SCROLLY;
		if (mx+LX>-10 && mx+LX<WIDTH*SCALE+10 && my+LY>-10 && my+LY<HEIGHT*SCALE+10)
			drawCircle2(mx,my,10);
	}
	C.endFill();
}


function mod(a,b)
{
	return (a%b+b)%b;
}

var sendOnce = 0;
function sendPlayerData()
{
	sendOnce++;
	if (sendOnce<2) return;
	sendOnce = 0;
	//px,py,size,vel,dir,color,targetDir,boost,nick,hp,stamina
	socket.emit('position',FISH[PLAYERID][6],FISH[PLAYERID][7]);
}

var canPlay = true;
var totalLines = 0;
function startSocket()
{
	if (!canPlay) return;
	canPlay = false;
	
	bubbleSnd.play();

	if (isMobile) openFullscreen();
	
	window.socket = io();
	
	document.getElementById('conn').style.visibility = 'visible'
	document.getElementById('conn').innerHTML = "Connecting...";
	
	socket.emit('accessToken',{color: COLOR.r * 65536 + COLOR.g * 256 + COLOR.b, nickname: node.value, type: MYTYPE});
	
	socket.on('noSlots',function(){
		document.getElementById('conn').innerHTML = "No slots available, we will add more rooms soon";
	});
	
	socket.on('chat',function(mess){
		if (gameStarted)
		{
			console.log(chatText.text.indexOf("\n"));
			chatText.text += "\n" + mess;
			if (totalLines>12) chatText.text = chatText.text.substr(chatText.text.indexOf("\n")+1);
			else totalLines++;
		}
	});
	
	socket.on('playerAdded',function(key,bound,id){
		BOTTOMKEY = key;
		BOUNDRIGHT = bound;
		PLAYERID = id;
		setTimeout(function(){waitForFirstPosition(true);},1000);
	});

	socket.on('died',function(){
		getSmaller = 0.9;
		setTimeout(fadeInMenu,1500);
	});
	
	var atmost = 0;
	function waitForFirstPosition(first)
	{
		if (first) atmost = 0;
		atmost++;
		if (atmost>15)
		{
			RELOAD();
		}
		if (POSTO[PLAYERID][0]!=0) startGame();
		else setTimeout(function(){waitForFirstPosition(false);},500);
	}
	
	socket.on('updatePlayers',function(fis,sha,boa,hun,delay){
		lastUpdate = TIME;
		var d = new Date();
		var timeAhead = mod(1000*d.getSeconds()+d.getMilliseconds()-delay,60)/16.67;
		//timeAhead = 0;
		//FISH = fis.data;
		//alert(fis.data[0][0].length);
		for (i=0;i<10;i++) // why 10???
		{
			if (!fis.data[i]) continue;
			POSTO[i][4] = fis.data[i][2];
			var vel = fis.data[i][3];
			POSTO[i][2] = POSTO[i][2]*0.9 + vel*0.1;
			var myTimeAhead = timeAhead + 1.3*Math.abs(POSTO[i][2]);
			var dir = fis.data[i][4];
			FISH[i][5] = fis.data[i][5];
			FISH[i][6] = fis.data[i][6];
			FISH[i][7] = fis.data[i][7];
			FISH[i][10] = fis.data[i][10];
			
			var nextHp = fis.data[i][9];
			if (nextHp<FISH[i][9])
			{
				vol = 50000 / (150000 + dis(FISH[i][0]-FISH[PLAYERID][0],FISH[i][1]-FISH[PLAYERID][1]));
				//console.log(vol);
				if (vol>0.1)
				{
					biteSnd.volume = vol;
					biteSnd.play();
				}
			}
			FISH[i][9] = nextHp;
			
			FISH[i][11] = fis.data[i][11];
			
			POSTO[i][0] = fis.data[i][0]+Math.cos(dir)*myTimeAhead*vel;
			POSTO[i][1] = fis.data[i][1]+Math.sin(dir)*myTimeAhead*vel;
			
			var turn = (mod(FISH[i][6]-dir,2*Math.PI)-Math.PI)*2.61/vel;
			if (turn>1) turn = 1;
			if (turn<-1) turn = -1;
			
			POSTO[i][3] = dir + 0.7*timeAhead*turn/(10+2*SIZE);
			
			if (FISH[i][8] != fis.data[i][8]) // new fish in - different name
			{				
				FISH[i][0] = POSTO[i][0];
				FISH[i][1] = POSTO[i][1];
				FISH[i][3] = POSTO[i][2];
				FISH[i][3] = POSTO[i][3];
				FISH[i][2] = POSTO[i][4];
				
				FISH[i][8] = fis.data[i][8];
			}
		}
		
		for (i=0;i<5;i++) // why 10???
		{
			if (!sha.data[i]) continue;
			SHARK[i][2] = sha.data[i][2];
			var vel = sha.data[i][3];
			var myTimeAhead = timeAhead + 1.3*Math.abs(vel);
			SHARKTO[i][2] = vel;
			var dir = sha.data[i][4];
			SHARKTO[i][3] = dir;
			SHARKTO[i][4] = sha.data[i][5];
			
			SHARKTO[i][0] = sha.data[i][0]+Math.cos(dir)*myTimeAhead*vel;
			SHARKTO[i][1] = sha.data[i][1]+Math.sin(dir)*myTimeAhead*vel;
		}
		
		boatVX = boa.vx;
		boatXTo = boa.x+boatVX*timeAhead;
		boatTargetX = boa.tx;
		//boatWaitTarget = boa.wt;
		//boatStop = boa.s;
		rodUp = boa.ru;
		hookVX = boa.hvx;
		hookVY = boa.hvy;
		hookXTo = boa.hx+hookVX*timeAhead;
		hookYTo = boa.hy+hookVY*timeAhead;
		veinLen = boa.vl;
		
		huntId = hun;
	});
}
		</script>
	</body>
</html>