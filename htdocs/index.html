

<html>
  <head>
    <meta charset="UTF-8">
    <title>Time 2 Swim</title>
	<link href="https://fonts.googleapis.com/css?family=Baloo" rel="stylesheet">
	<link rel="shortcut icon" href="htdocs/icon.ico" />
	<script>
	
function setF(){
	C.endFill();
	if (gameStarted)
	{
		FX = FISH[PLAYERID][0];
		FY = FISH[PLAYERID][1];
		DIR = FISH[PLAYERID][4];
		SIN = Math.sin(DIR);
		COS = Math.cos(DIR);
		VEL = FISH[PLAYERID][3];
	}
	else
	{
		FX = SCROLLX + WIDTH/2;
		FY = SCROLLY + HEIGHT/2+65;
		SIN = 0;
		COS = -1;
		VEL = 0.5;
	}
	SIZE = 0.7+3.5*ele.style.opacity;
	renderFish();
};
var anim = {p: 0, f: 0,d: new Function()};
function fadeInMenu(){
	anim.d = function(){
		if (anim.p == 1)
		{		
			gameStarted = false;
			justStarted = false;
			getSmaller = 1;
			document.getElementById("lol").style.display = "block";
			document.getElementById('conn').style.visibility = 'hidden';
			highScoreText.text = 'Your highest score: ' + highScore;
		}
		if(anim.p <= 30){
			var much = 40 - Math.cos(anim.p * Math.PI / 60) * 40;
			ele.style.paddingTop = much;
			highScoreText.y = HEIGHT/2+115 + much;
			setAlpha(Math.sin(anim.p * Math.PI / 60));
		}else{
			clearInterval(anim.f);
			anim.p = 0;
		};
		anim.p++;
	};
	anim.f = setInterval(anim.d,16.7);
	document.getElementById('playBtn').innerText = "Play";
};
function fadeOutMenu(){
	anim.d = function(){
		if(anim.p <= 30){
			var much = Math.cos(anim.p * Math.PI / 60) * 40;
			ele.style.paddingTop = much;
			highScoreText.y = HEIGHT/2+115 + much;
			setAlpha(1 - Math.sin(anim.p * Math.PI / 60));
		} else {
			document.getElementById("lol").style.display = "none";
			clearInterval(anim.f);
			anim.p = 0;
		};
		anim.p++;
	};
	anim.f = setInterval(anim.d,16.7);
};
function setAlpha(op)
{
	ele.style.opacity = op;
	scoreText.alpha = 1-op;
	scoreMeText.alpha = 1-op;
	hpText.alpha = 1-op;
	o2Text.alpha = 1-op;
	highScoreText.alpha = op;
	if (diedText.alpha>0) diedText.alpha -= 0.05;
	for (i=0;i<FISH.length;i++) {
		displayNames[i].alpha = 1-op;
	}
}
</script>
	<style>
	body {
		background-color: #4477bb;
		width: 100%;
		padding: 0px;
		margin: 0px;
		position: fixed;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}
	canvas {
		background-color: transparent;
		z-index: -1;
	}
	input:focus, button:focus{
		outline: none;
	}
	.cs{
		width: 14px;
		height: 14px;
		margin: 3px;
		float: left;
		border-radius: 3px;
		padding: 3px;
		box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-webkit-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-moz-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		transition: width 0.3s, height 0.3s, margin 0.3s;
	}
	.cs:hover{
		width: 24px;
		height: 24px;
		margin: -2px;
		cursor: pointer;
	}
	.csH{
		padding: 0px;
		border: 3px white solid;
	}
	.csH:hover{
		border: 3px white solid;
	}
	#container
	{
		width: 1000px;
		margin-left: auto;
		margin-right: auto;
	}
	button,input,select{
		border: 1px black solid;
		height: 40px;
		font-size: 20px;
		box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-webkit-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-moz-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
	}
	input{
		padding-top: 3px;
		border-radius: 20px 0 0 20px;
		text-indent: 15px;
		font-family: lucida console;
	}
	#playBtn {
		background-color: #59f;
		font-size: 24px;
		border-radius: 0 20px 20px 0;
		margin-left: -4px;
		width: 70px;
		font-family: "Baloo";
		color: white;
		transition: all 0.15s;
	}
	#playBtn:hover{
		background-color: #6Bf;
	}
	a{
		color: lightBlue;
	}
	.textShadow{
		text-shadow:
			0px -1px 0 rgba(255,255,255,0.7),
			-1px 1px 0 rgba(0,0,0,0.6),
			1px 1px 0 rgba(0,0,0,0.6);
	}
	font{
		color: #3b3;
		position: relative;
	}
	#f1,#f2,#f3,#f6,#f7,#f8{
		margin-right: -8px;
	}
</style>
	<script src="socket.io/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.0.0/pixi.min.js"></script>
  </head>
	<body onload="init();" onresize='resize();'>
		<div align="center">
			<canvas id="game-canvas" width="1000" height="600"></canvas>
			<div id=lol style="padding-top: 40px;background-color:transparent;position:absolute;opacity:1">
				<div id=menu style="padding: 20px; height: 400px; width: 320px; margin-top: 20%;">
					<div style="font-family: Baloo; font-size: 50px; text-align: center;width: 100%; font-weight: bold;" class="textShadow">
						<font id = "f1">T</font>
						<font id = "f2">i</font>
						<font id = "f3">m</font>
						<font id = "f4">e</font>
						<font id = "f5">2</font>
						<font id = "f6">S</font>
						<font id = "f7">w</font>
						<font id = "f8">i</font>
						<font id = "f9">m</font>
					</div>
					<br><br>
					<input type=text id=nickname maxlength=18 autofocus/>
					<button class="textShadow" id=playBtn onclick="startSocket();">Play</button>
					<div id="conn" style="margin-top:5px; visibility: hidden">Connecting...</div>
					<div id=customize style="margin-top: 250px; width: 320px;">
						<div class=cs style="background-color: #f00"></div>
						<div class=cs style="background-color: #ff8000"></div>
						<div class=cs style="background-color: #ff0"></div>
						<div class=cs style="background-color: #80ff00"></div>
						<div class=cs style="background-color: #0f0"></div>
						<div class=cs style="background-color: #00ff80"></div>
						<div class=cs style="background-color: #0ff"></div>
						<div class=cs style="background-color: #007fff"></div>
						<div class=cs style="background-color: #00f"></div>
						<div class=cs style="background-color: #7f00ff"></div>
						<div class=cs style="background-color: #f0f"></div>
						<div class=cs style="background-color: #ff0080"></div>
					</div>
					<div style="clear: both"></div>
				</div>
			</div>
		</div>
		<script>
		var node = document.getElementById('nickname');
		/*node.addEventListener('keydown', function onEvent(event) {
			if (event.key === "Enter") {
				startSocket();
			}
		});*/
		
		var COLOR = {r:255,g:0,b:0};
		
		function heh(col){
			var el = document.getElementsByClassName("csH")[0];
			if (el) el.className = "cs";
			var arel = document.getElementsByClassName("cs");
			for (i=0;i<arel.length;i++){
				if(arel[i].style.backgroundColor != col) continue;
				arel[i].className = "cs csH";
				col = col.substr(4);
				var iu = col.indexOf(',');
				COLOR.r = Math.round(col.substr(0,iu));
				col = col.substr(iu+2);
				iu = col.indexOf(',');
				COLOR.g = Math.round(col.substr(0,iu));
				col = col.substr(iu+2);
				iu = col.indexOf(')');
				COLOR.b = Math.round(col.substr(0,iu));
				setF();
			};
		};
		var arel = document.getElementsByClassName("cs");
		for(i = 0;i < arel.length; i++){
			var col = arel[i].style.backgroundColor;
			arel[i].onclick = new Function("heh('" + col + "')");
		};
		var ele = document.getElementById("lol");
		
		var letters = [];
		for (i=0;i<9;i++) {
			letters[i] = document.getElementById("f"+(i+1));
		}
		</script>
		<script>
var CANVAS, C, WIDTH, HEIGHT;
var SCROLLX, SCROLLY;
var MOUSEX, MOUSEY, LMB;
var PLANKTON = [];
var TIME = 0;

var PLAYERID = -1;

var BOTTOM = [], BOTTOMSIZE = 50;
/*	[2200,150,500,2,Math.PI,[255,0,100],0,0,"",100,100],
	[2300,200,1,2,1,[0,255,100],0,0,"",100,100],
];*/
var FISH = []; // px,py,size,vel,dir,color,targetDir,boost,nick,hp,stamina
var POSTO = [];
var SHARK = []; // px,py,size,vel,dir,targetDir
var SHARKTO = [];
var BOUNDRIGHT = 7000;

for (i=0;i<10;i++)
{
	FISH.push([0,0,0,0,0,0,0,0,"",0,0]);
	POSTO.push([0,0,0,0,0]);
	SHARK.push([0,0,0,0,0,0]);
	SHARKTO.push([0,0,0,0,0]);
}

var renderer;

var highScore = 0;
var hpText, o2Text, scoreText, scoreMeText, diedText, highScoreText;
var HPsmooth = 0;
var O2smooth = 0;

var displayNames = [];

var skywater;

//var points = []; of fish mesh rope

var canvas;

function RELOAD()
{
	alert("You've been kicked, server is down or you lost internet connection.");
	location.reload();
	return;
}

function resize() {	
    WIDTH = window.innerWidth;
    HEIGHT = window.innerHeight;
	
	if (WIDTH<640) WIDTH = 640;
	if (WIDTH>1600) WIDTH = 1600;
	if (HEIGHT<480) HEIGHT = 480;
	if (HEIGHT>1000) HEIGHT = 1000;
	
	canvas.width = WIDTH;
	canvas.height = HEIGHT;
	
	this.renderer.resize(WIDTH, HEIGHT);
	
	scoreMeText.x = WIDTH-120;
	scoreText.x = WIDTH-120;
	
	var conq = canvas.getBoundingClientRect();
	
	ele.style.left = Math.round(WIDTH/2-173)+conq.left+"px";
	ele.style.top = Math.round(HEIGHT/2-350)+"px";
	
	skywater.width = WIDTH;
	
	diedText.x = WIDTH/2;
	diedText.y = HEIGHT/2-150;
	
	highScoreText.x = WIDTH/2;
	highScoreText.y = HEIGHT/2+150;
	
	if (!gameStarted) setF();
}
function init() {
	stage = new PIXI.Container();
	
	canvas = document.getElementById("game-canvas");
	
	renderer = PIXI.autoDetectRenderer(WIDTH,HEIGHT,{view:canvas,antialias:true});
	
	window.addEventListener("mousedown", mouseDown);
	window.addEventListener("mouseup", mouseUp);
	
	skywater = new PIXI.Sprite(PIXI.Texture.fromImage("htdocs/skywater.png"));
	skywater.position.x = 0;
	skywater.position.y = 0;
	skywater.width = WIDTH;
	skywater.height = 3000;//HEIGHT;
	
	C = new PIXI.Graphics();
	
	hpText = new PIXI.Text('HP', {
        fontSize: 20,
        fontFamily: 'Lucida Console',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#888888',
        strokeThickness: 3
    });
	hpText.x = 30;
	hpText.y = 29;
	hpText.alpha = 0;
	
	o2Text = new PIXI.Text('O₂', {
        fontSize: 20,
        fontFamily: 'Lucida Console',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#888888',
        strokeThickness: 3
    });
	o2Text.x = 30;
	o2Text.y = 64;
	o2Text.alpha = 0;
	
	scoreText = new PIXI.Text('SCORE: 1', {
        fontSize: 20,
        fontFamily: 'Baloo',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	scoreText.y = 25;
	scoreText.anchor.set(0.5, 0);
	scoreText.alpha = 0;
	
	scoreMeText = new PIXI.Text('SCORE', {
        fontSize: 20,
        fontFamily: 'Baloo',
        fill: '#FFFF00',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	scoreMeText.y = 25;
	scoreMeText.anchor.set(0.5, 0);
	scoreMeText.alpha = 0;
	
	diedText = new PIXI.Text('You died', {
        fontSize: 48,
        fontFamily: 'Georgia',
        fill: '#FF0000',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	diedText.anchor.set(0.5, 0);
	diedText.alpha = 0;
	
	highScoreText = new PIXI.Text('', {
        fontSize: 28,
        fontFamily: 'Baloo',
        fill: '#FFFF88',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	highScoreText.anchor.set(0.5, 0);
	//highScoreText.alpha = 0;
	
	stage.addChild(skywater,C,hpText,o2Text,scoreText,scoreMeText,diedText,highScoreText);
	
	for (i=0;i<FISH.length;i++) {
		displayNames[i] = new PIXI.Text('hey', {
			fontSize: 18,
			fontFamily: 'Baloo',
			fill: '#FFFFFF',
			align: 'center',
			stroke: '#000000',
			strokeThickness: 2,
		});
		displayNames[i].x = 300+70*i;
		displayNames[i].y = 250;
		displayNames[i].anchor.set(0.5, 0);
		displayNames[i].alpha = 0;;
		stage.addChild(displayNames[i]);
	}
	
	document.getElementById("lol").style.zIndex = 1;
	canvas.style.zIndex = -1;
	document.getElementById("lol").style.position = "absolute";
	
	requestAnimationFrame(update);
	
	resize();
		
	var col = arel[Math.floor((arel.length-0.01)*Math.random())].style.backgroundColor;
	heh(col);
	
	canvas.focus();
	node.focus();
}

var WIDTH = 1000;
var HEIGHT = 600;
var SCROLLX = 600;
var SCROLLY = -200;
var TIME = 0;

var gameStarted = false;
var justStarted = false;
var getSmaller = 1;
function startGame()
{
	randomizeBottom();
	randomizePlankton();
	
	levelAlert = 0;
	
	MOUSEX = 0;
	MOUSEY = 0;
	
	HPsmooth = 100;
	O2smooth = 100;
	
	deltaTime = 1;
	justStarted = true;
	gameStarted = true;
	getSmaller = 1;
	
	fadeOutMenu();
	//loop();
	canvas.focus();
}

function getSize(s)
{
	return 0.7*Math.pow(s,0.35);
}

var lastTime = 0;
var levelAlert = 0;
var deltaTime = 1;
var SOFT = 0;
var lastUpdate = 0;
function update(time)
{
	TIME = time/15;
	
    if (lastTime) {
        deltaTime = deltaTime*0.5+(time - lastTime)/33.4;
		if (deltaTime>3) deltaTime = 3;
    }
    lastTime = time;
	
	C.clear();
	
	if (gameStarted)
	{
		if (justStarted)
		{
			SCROLLX = POSTO[PLAYERID][0]-WIDTH/2;
			SCROLLY = POSTO[PLAYERID][1]-HEIGHT/2-65;
			SOFT = 0;
			justStarted = false;
			lastUpdate = TIME;
		}
		else
		{
			SOFT = Math.pow(0.95,deltaTime);
			control();
			
			if (POSTO[PLAYERID][0]==0 || TIME-lastUpdate>300)
			{
				RELOAD();
			}
		}
		
		input();
		
		skywater.y = -1180-SCROLLY;
		
		renderPlankton();
		
		var len = 270 + 80 * Math.sin(TIME*0.01);
		var shift = 150 + 80 * Math.sin(TIME*0.003427);
		
		for (i=0;i<SHARK.length;i++)
		{
			if (!SHARK[i] || SHARKTO[i][0]==0) continue;
			
			var fish = SHARK[i];
			var vel = fish[3];
			var dir = fish[4];
			FX = fish[0];
			FY = fish[1];
			SIN = Math.sin(dir);
			COS = Math.cos(dir);
			SIZE = fish[2];
			VEL = fish[3];
			var mouthX = FX + COS*SIZE*18;
			var mouthY = FY + SIN*SIZE*18;
			
			SHARK[i][0] = (FX + vel*COS*deltaTime) * SOFT + SHARKTO[i][0] * (1-SOFT);
			SHARK[i][1] = (FY + vel*SIN*deltaTime) * SOFT + SHARKTO[i][1] * (1-SOFT);
			SHARK[i][3] = VEL * SOFT + SHARKTO[i][2] * (1-SOFT);
			SHARK[i][4] = dir * SOFT + SHARKTO[i][3] * (1-SOFT);
			SHARK[i][5] = SHARK[i][5] * SOFT + SHARKTO[i][4] * (1-SOFT);
			
			var followClosest = 10000000;
			
			for (a=0;a<FISH.length;a++)
			{
				if (!FISH[i] || !POSTO[i] || POSTO[i][0]==0) continue;
			
				var dx = FISH[a][0]-mouthX;
				var dy = FISH[a][1]-mouthY;
				var dist = dis(dx,dy);
				var s2 = getSize(FISH[a][2]);
				
				if (FY>30 && dist<60000)
				{
					if (dist < followClosest)
					{
						followClosest = dist
						SHARK[i][5] = Math.atan2(dy,dx);
					}
				}
				
				if (dist<Math.pow(SIZE*2+s2,2)*25)
				{
					FISH[a][9] -= 3/(2+s2)*deltaTime;
				}
			}
			
			if (FY > SIZE * 5.9)
			{
				var turn = (mod(SHARK[i][5]+Math.PI-dir,2*Math.PI)-Math.PI);
				if (turn>1) turn = 1;
				if (turn<-1) turn = -1;
				
				SHARK[i][4] += deltaTime*turn/(10+10*SIZE);
			}
			
			var how = mod(FX/BOTTOMSIZE,1);
			var le = BOTTOM[Math.floor(FX/BOTTOMSIZE)];
			var ri = BOTTOM[Math.ceil(FX/BOTTOMSIZE)];
			var bottom = le*(1-how) + ri*how - SIZE * 6;
			if (FY > bottom)
			{
				var much = (FY - bottom)*0.3;
				SHARK[i][3] *= 1-0.01*much*deltaTime;
				SHARK[i][0] += much * (ri-le)/BOTTOMSIZE * deltaTime;
				SHARK[i][1] -= much * deltaTime;
				
				much = SIZE * 3 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					SHARK[i][4] += SIN * (COS<0?1:-1) * 0.02 * much * deltaTime;
					SHARK[i][3] *= 1 - 0.03*deltaTime;
				}
			}
			else if (FY < SIZE * 3)
			{
				much = SIZE * 3 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					SHARK[i][4] += much * (COS>0?0.01:-0.01)/(Math.abs(VEL)+0.1) * deltaTime;
					SHARK[i][3] += much * SIN * 0.025 * deltaTime;
				}
			}
			else SHARK[i][3] = SHARK[i][3]*(1-0.1*deltaTime) + 0.25*deltaTime;
			
			var mx = FX-SCROLLX;
			var my = FY-SCROLLY;
			if (mx>-25*SIZE && mx<WIDTH+25*SIZE && my>-25*SIZE && my<HEIGHT+25*SIZE) renderShark();
		}
		
		for (i=0;i<FISH.length;i++)
		{
			if (!FISH[i] || !POSTO[i] || POSTO[i][0]==0)
			{
				//alert(FISH.length+" hey");
				displayNames[i].y = -100;
				continue;
			}
			//else alert(FISH.length+" nope");
			
			var fish = FISH[i];
			var dir = fish[4];
			FX = fish[0];
			FY = fish[1];
			SIN = Math.sin(dir);
			COS = Math.cos(dir);
			SIZE = getSize(fish[2]);
			VEL = fish[3];
			col = fish[5];
			COLOR.b = col%256;
			col = (col - COLOR.b)/256;
			COLOR.g = col%256;
			col = (col - COLOR.g)/256;
			COLOR.r = col%256;
			FISH[i][0] = (FX + VEL*COS*deltaTime) * SOFT + POSTO[i][0] * (1-SOFT);
			FISH[i][1] = (FY + VEL*SIN*deltaTime) * SOFT + POSTO[i][1] * (1-SOFT);
			FISH[i][3] = VEL * SOFT + POSTO[i][2] * (1-SOFT);
			FISH[i][4] = dir * SOFT + POSTO[i][3] * (1-SOFT);
			FISH[i][2] = fish[2] * SOFT + POSTO[i][4] * (1-SOFT);
			
			var mouthX = FX + COS*SIZE*18;
			var mouthY = FY + SIN*SIZE*18;
			
			FISH[i][2] -= 0.00001*(SIZE-0.7)*(200-FISH[i][9]);
			
			if (getSmaller<0.99)
			{
				if (diedText.alpha<1) diedText.alpha += 0.05;
				if (i==PLAYERID) SIZE*=getSmaller;
				getSmaller-=0.1;
				if (getSmaller<=0) continue;
			}
			
			for (a=0;a<PLANKTON.length;a++)
			{
				var px = PLANKTON[a][0];
				px += 5*Math.sin(px*0.01+TIME*0.05);
				if (dis(px-mouthX,PLANKTON[a][1]-mouthY) < SIZE*SIZE*250+20)
				{
					socket.emit("tasty",0.1);
					
					var x = Math.random()*(BOUNDRIGHT-2800)+1400;
					if (x-SCROLLX>-10 && x-SCROLLX<WIDTH+10)
					{
						if (SCROLLX<BOUNDRIGHT/2) x+=2500;
						else x-=2500;
					}
					
					var le = BOTTOM[Math.floor(x/BOTTOMSIZE)];
					var ri = BOTTOM[Math.ceil(x/BOTTOMSIZE)];
					if (le<ri) ri = le;
					
					var y = Math.random() * (ri-100) + 50;
					
					PLANKTON[a]=[x,y];
					//FISH[i][2] += 0.1;
				}
			}
			
			/*for (a=i+1;a<FISH.length;a++)
			{
				var s2 = 0.7*Math.pow(FISH[a][2],0.4);
				if (Math.pow(FISH[a][0]-FX,2)+Math.pow(FISH[a][1]-FY,2)<Math.pow(SIZE+s2,2)*100+50)
				{
					if (SIZE > s2)
					{
						FISH[i][2] += s2;
						FISH.splice(a,1);
					}
					else
					{
						FISH[a][2] += SIZE;
						FISH.splice(i,1);
						continue;
					}
				}
			}*/
			
			if (FY > SIZE * 5.9)
			{
				var turn = (mod(FISH[i][6]-dir,2*Math.PI)-Math.PI);
				if (turn>1) turn = 1;
				if (turn<-1) turn = -1;
				
				FISH[i][4] += deltaTime*turn/(10+5*SIZE);
				
				if (FISH[i][7] && FISH[i][10]>0.5)
				{
					FISH[i][3] += 0.2;
					FISH[i][10] -= 0.5;
				}
			}
			FISH[i][10] += 0.1;
			if (FISH[i][10]>100) FISH[i][10] = 100;
			
			var how = mod(FX/BOTTOMSIZE,1);
			var le = BOTTOM[Math.floor(FX/BOTTOMSIZE)];
			var ri = BOTTOM[Math.ceil(FX/BOTTOMSIZE)];
			var bottom = le*(1-how) + ri*how - SIZE * 12;
			if (FY > bottom)
			{
				var much = (FY - bottom)*0.3;
				FISH[i][3] *= 1-0.01*much*deltaTime;
				FISH[i][0] += much * (ri-le)/BOTTOMSIZE * deltaTime;
				FISH[i][1] -= much * deltaTime;
				
				much = SIZE * 6 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					FISH[i][4] += SIN * (COS<0?1:-1) * 0.02 * much;
					FISH[i][3] *= 1 - 0.03*deltaTime;
					FISH[i][9] -= 0.5 * deltaTime;
				}
			}
			else if (FY < SIZE * 6)
			{
				much = SIZE * 6 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					FISH[i][4] += much * (COS>0?0.02:-0.02)/(Math.abs(VEL)+0.1) * deltaTime;
					FISH[i][3] += much * SIN * 0.025 * deltaTime;
					FISH[i][1] += 0.1;
				}
			}
			else FISH[i][3] = FISH[i][3]*0.9 + 0.25;
			
			if (FISH[i][9]<=0)
			{
				FISH[i][3] = 0;
				FISH[i][9] = 0;
			}
			else
			{
				FISH[i][9] += 0.03*deltaTime;
				if (FISH[i][9]>100) FISH[i][9] = 100;
			}
			
			var mx = FX-SCROLLX;
			var my = FY-SCROLLY;
			if (mx>-25*SIZE && mx<WIDTH+25*SIZE && my>-25*SIZE && my<HEIGHT+25*SIZE)
			{
				renderFish();
				displayNames[i].x = FX-SCROLLX;
				displayNames[i].y = FY-SIZE*33-30-SCROLLY;
				displayNames[i].text = FISH[i][8];
			}
			else displayNames[i].y = -100;
			
			
			/*FX = POSTO[i][0];
			FY = POSTO[i][1];
			
			renderFish();*/
			
			//for (p=0;p<30;p++) {renderFish();FX+=25;if (FX>SCROLLX+800) {FX = SCROLLX+200; FY+=25;}}
		}
		
		if (ele.style.opacity>0.05) setF();
		
		renderWater();
		renderBottom();
		
		face();
		
		sendPlayerData();
	}
	else
	{
		for (i=0;i<9;i++) {
			letters[i].style.top = Math.round(11*Math.sin(TIME*0.04+i*0.7))+"px";
		}
		setF();
	}
	
	renderer.render(stage);
	
    requestAnimationFrame(update);

	//setTimeout(update,1000/6000);
}

function compareNumbers(a, b) {
   return b[1] - a[1];
}

function face()
{
	HPsmooth = HPsmooth*0.8 + FISH[PLAYERID][9]*0.2;
	O2smooth = O2smooth*0.8 + FISH[PLAYERID][10]*0.2;
	
	var list = [];
	/*list.push(["maja",17]);
	list.push(["maja",17]);
	list.push(["dupa",15]);
	list.push(["gdspa",12]);
	list.push(["dupa2",10]);
	list.push(["dupa4",9]);
	list.push(["dupa5",11]);
	list.push(["dupa5",14]);
	list.push(["heniek1234",13]);*/
	for (i=0;i<FISH.length;i++)
	{
		if (POSTO[i][0] == 0) continue;
		
		var currSc = Math.round(FISH[i][2] * 10);
		if (i==PLAYERID)
		{
			if (currSc > highScore) highScore = currSc;
			currSc += 0.5;
		}
		if (currSc>0) list.push([FISH[i][8],currSc]);
	}
	list.sort(compareNumbers);
	
	var name = FISH[PLAYERID][8];
	
	var nr = 0;
	for (i=0;i<list.length;i++)
	{
		if (list[i][0] == name)
		{
			nr = i;
			break;
		}
	}
	
	var a = 9;
	
	var print = "⁌LEADERBOARD⁍";
	var print2 = "";
	for (i=0;i<list.length && i<a;i++)
	{
		if (nr>=a && i==a-2)
		{
			print += "\n...";
			print += "\n" + (nr+1) + ". " + name + " - " + Math.floor(list[nr][1]);
			print2 += "\n\n" + (nr+1) + ". " + name + " - " + Math.floor(list[nr][1]);
			break;
		}
		else
		{
			if (list[i][0] == name) print2 += "\n" + (i+1) + ". " + list[i][0]+" - "+Math.floor(list[i][1]);
			else print2 += "\n";
			print += "\n" + (i+1) + ". " + list[i][0]+" - "+Math.floor(list[i][1]);
		}
	}
	if (a<list.length && list.length>nr) print += "\n...";
	scoreText.text = print;
	scoreMeText.text = print2;
	
	C.lineStyle(2, 0x440000);
	C.beginFill(0x880000, 0.6);
	C.drawRoundedRect(25, 27, 120, 26, 10);
	C.endFill();
	
	if (HPsmooth>0.1)
	{
		var edge = 10;
		if (0.6*HPsmooth<10) edge = 0.6*HPsmooth;
		C.lineStyle(null);
		C.beginFill(0xFF0000, 0.6);
		C.drawRoundedRect(25, 32-edge*0.5, 1.2*HPsmooth, 16+edge, edge);
		C.endFill();
	}
	
	C.lineStyle(2, 0x225588);
	C.beginFill(0x3366AA, 0.6);
	C.drawRoundedRect(25, 62, 120, 26, 10);
	C.endFill();
	
	if (O2smooth>0.1)
	{
		var edge = 10;
		if (0.6*O2smooth<10) edge = 0.6*O2smooth;
		C.lineStyle(null);
		C.beginFill(0x55BBFF, 0.6);
		C.drawRoundedRect(25, 67-edge*0.5, 1.2*O2smooth, 16+edge, edge);
		C.endFill();
	}
	
	//C.lineStyle
	C.beginFill(0x000000,0.3);
	C.drawRoundedRect(WIDTH-230,15,220,270,10);
	C.endFill();
}

function rgbToHex(r, g, b) {
    return "0x"+(((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1));
}

function renderFish()
{
	var colorOut = rgbToHex(Math.round(COLOR.r*0.8),Math.round(COLOR.g*0.8),Math.round(COLOR.b*0.8));
	var colorIn = rgbToHex(COLOR.r,COLOR.g,COLOR.b);
	
	var tirl = VEL*Math.cos(0.15*TIME);
	var twirl = VEL*2*Math.sin(0.15*TIME);
	var yummy = 3.5*Math.sin(0.1*TIME);
	
	if (ele.style.opacity > 0)
	{
		yummy = 0;
		C.lineStyle(null);
		C.beginFill(0x006699,Math.round(ele.style.opacity*10)/10);
		C.drawRect(0,0,WIDTH,HEIGHT);
		C.endFill();
	}
	
	C.lineStyle(null);
	C.beginFill(colorOut);
	
	swirlRot2(18,twirl*0.5,true);
	swirlRot2(31-0.2*twirl,-15-tirl);
	swirlRot2(29+0.2*twirl,15-tirl);
	
	C.closePath();
	C.endFill();
	
	C.beginFill(colorOut);
	
	swirlRot2(-21,-1,true);
	swirlRot2(9-0.5*tirl,21+0.5*twirl);
	swirlRot2(7,4);
	swirlRot2(8+0.5*tirl,-22+0.5*twirl);
	
	C.closePath();
	C.endFill();
	
	C.beginFill(colorIn)
	
	var pl = swirlPoint2(-24,1-tirl);
	var plmo = swirlPoint2(-24,6-yummy-tirl);
	var plmi = swirlPoint2(-12,3-tirl*0.5);
	var pr = swirlPoint2(24,twirl*0.5);
	var plu = swirlPoint2(-20,-24-twirl);
	var pld = swirlPoint2(-20,19-twirl);
	var pru = swirlPoint2(20,-20+twirl);
	var prd = swirlPoint2(15,18+twirl);
	var peye = swirlPoint2(-14,-7-twirl*0.25);
	C.moveTo(pl[0],pl[1]);
	C.bezierCurveTo(plu[0],plu[1],pru[0],pru[1],pr[0],pr[1]);
	C.bezierCurveTo(prd[0],prd[1],pld[0],pld[1],plmo[0],plmo[1]);
	C.lineTo(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.lineStyle(SIZE*2.5,0xffffff);
	C.beginFill(0x000000);
	C.drawCircle(peye[0],peye[1],SIZE*4);
	C.endFill();
}

function renderShark()
{
	C.lineStyle(null);
	C.beginFill(0x788F96);
	
	var tirl = VEL*0.5*Math.cos(0.15*TIME);
	var twirl = VEL*Math.sin(0.15*TIME);
	var yummy = 1.75*Math.sin(0.1*TIME);
	
	swirlRot2(18,twirl*0.5,true);
	swirlRot2(31-0.2*twirl,-7.5-tirl);
	swirlRot2(29+0.2*twirl,7.5-tirl);
	
	C.closePath();
	C.endFill();
	C.beginFill(0x788F96);
	
	swirlRot2(-21,-0.5,true);
	swirlRot2(9-0.5*tirl,10.5+0.5*twirl);
	swirlRot2(7,4);
	swirlRot2(8+0.5*tirl,-11+0.5*twirl);
	
	C.closePath();
	C.endFill();
		
	C.beginFill(0x89A4AD);
	
	var pl = swirlPoint2(-24,0.5-tirl);
	var plmo = swirlPoint2(-24,3-yummy-tirl);
	var plmi = swirlPoint2(-12,1.5-tirl*0.5);
	var pr = swirlPoint2(24,twirl*0.5);
	var plu = swirlPoint2(-20,-12-twirl);
	var pld = swirlPoint2(-20,9.5-twirl);
	var pru = swirlPoint2(20,-10+twirl);
	var prd = swirlPoint2(15,9+twirl);
	var peye = swirlPoint2(-14,-3.5-twirl*0.25);
	C.moveTo(pl[0],pl[1]);
	C.bezierCurveTo(plu[0],plu[1],pru[0],pru[1],pr[0],pr[1]);
	C.lineTo(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.beginFill(0xDDDDEE);
	C.moveTo(pr[0],pr[1]);
	C.bezierCurveTo(prd[0],prd[1],pld[0],pld[1],plmo[0],plmo[1]);
	C.lineTo(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.beginFill(0x000000);
	C.lineStyle(SIZE*1.75,0xffffff);
	C.drawCircle(peye[0],peye[1],SIZE*2);
	C.endFill();
}

function swirlRot2(x,y,first)
{
	if (COS>0) y = -y;
	x*=SIZE;
	y*=SIZE;
	if (first) C.moveTo(FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY);
	else C.lineTo(FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY);
}

function swirlPoint2(x,y)
{
	if (COS>0) y = -y;
	x*=SIZE;
	y*=SIZE;
	return [FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY];
}

function control()
{
	var x = FISH[PLAYERID][0];
	var y = FISH[PLAYERID][1];
	//var x = POSTO[PLAYERID][0];
	//var y = POSTO[PLAYERID][1];
	
	//var SOFT = deltaTime*0.03;
	if (SOFT==0) return;
	
	//SOFT = 0.95;//(1-ele.style.opacity);
	
	SCROLLX = SCROLLX * SOFT + (0.5 * MOUSEX - 0.75 * WIDTH + x) * (1-SOFT);
	SCROLLY = SCROLLY * SOFT + (0.5 * MOUSEY - 0.75 * HEIGHT + y) * (1-SOFT);
	
	if (SCROLLX<0) SCROLLX = 0;
	if (SCROLLX>BOUNDRIGHT-WIDTH) SCROLLX = BOUNDRIGHT-WIDTH;
	
	FISH[PLAYERID][6] = -Math.PI/2-Math.atan2(MOUSEX+SCROLLX-x,MOUSEY+SCROLLY-y);
	FISH[PLAYERID][7] = LMB;
}

function renderBottom()
{
	/*C.lineJoin = "round";
	C.fillStyle="#918639";
	C.strokeStyle = "#6E652B";
	C.beginPath();
	C.lineWidth = 2;*/
	
	C.lineStyle(2, 0x6E652B);
	
	C.beginFill(0x817639);
	//C.strokeThickness = 3;
	
	C.moveTo(0,2*HEIGHT);
	
	for (x=0;x<WIDTH/BOTTOMSIZE+2;x++)
	{
		C.lineTo(x*BOTTOMSIZE-mod(SCROLLX,BOTTOMSIZE),BOTTOM[x+Math.floor(SCROLLX/BOTTOMSIZE)]-SCROLLY);
	}
	
	C.lineTo(WIDTH,2*HEIGHT);
	C.endFill();
}

function input()
{
	if (getSmaller<0.99) return;
	var mousePosition = renderer.plugins.interaction.mouse.global;
	MOUSEX = mousePosition.x;
	MOUSEY = mousePosition.y;
}

function mouseDown(e)
{
	if (e.button == 0) LMB = true;
}

function mouseUp(e)
{
	if (e.button == 0) LMB = false;
}

function dis(dx,dy)
{
	return dx*dx+dy*dy;
}

function squared(n)
{
	return n*n;
}

function renderWater()
{
	C.lineStyle(3, 0xFFFFFF, 0.1);
	C.beginFill(0x006699, 0.4);
	
	C.moveTo(0,HEIGHT);
	
	for (x=-2;x<WIDTH+10;x+=10)
	{
		C.lineTo(x,2*Math.sin(0.1*(x+SCROLLX+TIME))-SCROLLY);
	}
	C.lineTo(WIDTH,HEIGHT);
	C.endFill();
}

function randomizeBottom()
{
	BOTTOM = [];
	MAPWIDTH = 250;
	MAPHEIGHT = 100;
	
	BOTTOM = [Math.random()-0.5];
	
	var vel = 0;
	for (x=1;x<BOUNDRIGHT/BOTTOMSIZE+2;x++)
	{
		vel = 0.99*vel + pseudoRandom(x);
		BOTTOM.push((BOTTOM[x-1] + vel) * 0.5);
	}
	
	for (x=0;x<BOTTOM.length;x++)
	{
		BOTTOM[x] = (BOTTOM[x]*20+350)*(Math.atan((x*BOTTOMSIZE-1500)/200)-Math.atan((x*BOTTOMSIZE+1500-BOUNDRIGHT)/200))-80;
	}
}

function pseudoRandom(i)
{
	return Math.abs(23*Math.sin(BOTTOMKEY*i+273*i)+23*Math.tan(BOTTOMKEY*i*(0.2-3*i)))%1-0.5;
}

function randomizePlankton()
{
	PLANKTON = [];
	
	for (x=1400;x<BOUNDRIGHT-1400;x+=100)
	{
		var le = BOTTOM[Math.floor(x/BOTTOMSIZE)];
		var ri = BOTTOM[Math.ceil(x/BOTTOMSIZE)];
		if (le<ri) ri = le;
		
		var y = Math.random() * (ri-100) + 50;
		
		PLANKTON.push([x+Math.random()*20-10,y+Math.random()*20-10]);
	}
}

function renderPlankton()
{
	C.lineStyle(2, 0x227744);
	C.beginFill(0x339955);
	for (i=0;i<PLANKTON.length;i++)
	{
		var px = PLANKTON[i][0];
		px += 5*Math.sin(px*0.01+TIME*0.05);
		var mx = px-SCROLLX;
		var my = PLANKTON[i][1]-SCROLLY;
		if (mx>-10 && mx<WIDTH+10 && my>-10 && my<HEIGHT+10)
			C.drawCircle(mx,my,6+i%3);
	}
	C.endFill();
}


function mod(a,b)
{
	return (a%b+b)%b;
}

var sendOnce = 0;
function sendPlayerData()
{
	sendOnce++;
	if (sendOnce<2) return;
	sendOnce = 0;
	//px,py,size,vel,dir,color,targetDir,boost,nick,hp,stamina
	socket.emit('position',FISH[PLAYERID][6],FISH[PLAYERID][7]);
}

function startSocket()
{
	window.socket = io();
	
	document.getElementById('conn').style.visibility = 'visible'
	document.getElementById('conn').innerHTML = "Connecting...";
	
	socket.emit('accessToken',{color: COLOR.r * 65536 + COLOR.g * 256 + COLOR.b, nickname: node.value});
	
	socket.on('noSlots',function(){
		document.getElementById('conn').innerHTML = "No slots available, we will add more rooms soon";
	});
	
	socket.on('playerAdded',function(key,bound,id){
		BOTTOMKEY = key;
		BOUNDRIGHT = bound;
		PLAYERID = id;
		setTimeout(function(){waitForFirstPosition(true);},1000);
	});

	socket.on('died',function(){
		getSmaller = 0.9;
		setTimeout(fadeInMenu,1500);
	});
	
	var atmost = 0;
	function waitForFirstPosition(first)
	{
		if (first) atmost = 0;
		atmost++;
		if (atmost>10)
		{
			RELOAD();
		}
		if (POSTO[PLAYERID][0]!=0) startGame();
		else setTimeout(function(){waitForFirstPosition(false);},500);
	}
	
	socket.on('updatePlayers',function(fis,sha,delay){
		lastUpdate = TIME;
		var d = new Date();
		var timeAhead = mod(1000*d.getSeconds()+d.getMilliseconds()-delay,60)/16.67;
		//FISH = fis.data;
		//alert(fis.data[0][0].length);
		for (i=0;i<10;i++) // why 10???
		{
			if (!fis.data[i]) continue;
			POSTO[i][4] = fis.data[i][2];
			var vel = fis.data[i][3];
			POSTO[i][2] = vel;
			var dir = fis.data[i][4];
			POSTO[i][3] = dir;
			FISH[i][5] = fis.data[i][5];
			FISH[i][6] = fis.data[i][6];
			FISH[i][7] = fis.data[i][7];
			FISH[i][8] = fis.data[i][8];
			FISH[i][9] = fis.data[i][9];
			FISH[i][10] = fis.data[i][10];
			
			POSTO[i][0] = fis.data[i][0]+Math.cos(dir)*timeAhead*vel;
			POSTO[i][1] = fis.data[i][1]+Math.sin(dir)*timeAhead*vel;
			
			if (FISH[i][0]==0) // new fish in
			{
				FISH[i][0] = POSTO[i][0];
				FISH[i][1] = POSTO[i][1];
				FISH[i][3] = POSTO[i][2];
				FISH[i][3] = POSTO[i][3];
				FISH[i][2] = POSTO[i][4];
			}
		}
		
		for (i=0;i<5;i++) // why 10???
		{
			if (!sha.data[i]) continue;
			SHARK[i][2] = sha.data[i][2];
			var vel = sha.data[i][3];
			SHARKTO[i][2] = vel;
			var dir = sha.data[i][4];
			SHARKTO[i][3] = dir;
			SHARKTO[i][4] = sha.data[i][5];
			
			SHARKTO[i][0] = sha.data[i][0]+Math.cos(dir)*timeAhead*vel;
			SHARKTO[i][1] = sha.data[i][1]+Math.sin(dir)*timeAhead*vel;
		}
	});
}
		</script>
	</body>
</html>