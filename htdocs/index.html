

<html>
  <head>
    <meta charset="UTF-8">
    <title>Time 2 Swim</title>
	<link href="https://fonts.googleapis.com/css?family=Baloo" rel="stylesheet">
	<link rel="shortcut icon" href="htdocs/icon.ico" />
	<script>
	
var was = false;
function setF(){
	if (gameStarted)
	{
		FX = FISH[PLAYERID][0];
		FY = FISH[PLAYERID][1];
		DIR = FISH[PLAYERID][4];
		SIN = Math.sin(DIR);
		COS = Math.cos(DIR);
		VEL = FISH[PLAYERID][3];
	}
	else
	{
		FX = SCROLLX + WIDTH/2 - 10;
		FY = SCROLLY + HEIGHT/2+65;
		SIN = 0;
		COS = -1;
		VEL = 0.5;
	}
	SIZE = 0.7+3.5*ele.style.opacity;
	type = MYTYPE;
	
	wasR = COLOR.r;
	wasG = COLOR.g;
	wasB = COLOR.b;
	COLOR.r = 0;
	COLOR.g = 57;
	COLOR.b = 100;
	FX += 2;
	FY += 5;
	renderFish();
	COLOR.r = wasR;
	COLOR.g = wasG;
	COLOR.b = wasB;
	FX -= 2;
	FY -= 5;
	renderFish();
	
	var op = ele.style.opacity;
	var hai = ele.style.paddingTop;
	var top = +hai.substr(0,hai.length-2)+HEIGHT/2;
	if (dis(MOUSEX+137-WIDTH/2,MOUSEY-70-HEIGHT/2)<2500)
	{
		C.lineStyle(2,0x999999,op);
		C.beginFill(0xFFFFFF,op);
		
		if (LMB && !was)
		{
			MYTYPE = MYTYPE%3+1;
			bubbleSnd.play();
		}
	}
	else
	{
		C.lineStyle(2,0x777777,op);
		C.beginFill(0xDDDDDD,op);
	}
	C.moveTo(-130+WIDTH/2,top);
	C.lineTo(-150+WIDTH/2,30+top);
	C.lineTo(-130+WIDTH/2,60+top);
	C.closePath();
	C.endFill();
	
	if (dis(MOUSEX-137-WIDTH/2,MOUSEY-70-HEIGHT/2)<2500)
	{
		C.lineStyle(2,0x999999,op);
		C.beginFill(0xFFFFFF,op);
		
		if (LMB && !was)
		{
			MYTYPE = (MYTYPE+1)%3+1;
			bubbleSnd.play();
		}
	}
	else
	{
		C.lineStyle(2,0x777777,op);
		C.beginFill(0xDDDDDD,op);
	}
	C.moveTo(130+WIDTH/2,top);
	C.lineTo(150+WIDTH/2,30+top);
	C.lineTo(130+WIDTH/2,60+top);
	C.closePath();
	C.endFill();
	
	was = LMB;
};
var anim = {p: 0, f: 0,d: new Function()};
function fadeInMenu(){
	anim.d = function(){
		if (anim.p == 1)
		{		
			gameStarted = false;
			justStarted = false;
			getSmaller = 1;
			document.getElementById("lol").style.display = "block";
			document.getElementById('conn').style.visibility = 'hidden';
			highScoreText.text = 'Your highest score: ' + highScore;
			canPlay = true;
		}
		if(anim.p <= 30){
			var much = 40 - Math.cos(anim.p * Math.PI / 60) * 40;
			ele.style.paddingTop = much;
			highScoreText.y = HEIGHT/2+115 + much;
			setAlpha(Math.sin(anim.p * Math.PI / 60));
		}else{
			clearInterval(anim.f);
			anim.p = 0;
		};
		anim.p++;
	};
	anim.f = setInterval(anim.d,16.7);
	document.getElementById('playBtn').innerText = "Play";
};
function fadeOutMenu(){
	anim.d = function(){
		if(anim.p <= 30){
			var much = Math.cos(anim.p * Math.PI / 60) * 40;
			ele.style.paddingTop = much;
			highScoreText.y = HEIGHT/2+115 + much;
			setAlpha(1 - Math.sin(anim.p * Math.PI / 60));
		} else {
			document.getElementById("lol").style.display = "none";
			clearInterval(anim.f);
			anim.p = 0;
		};
		anim.p++;
	};
	anim.f = setInterval(anim.d,16.7);
};
function setAlpha(op)
{
	ele.style.opacity = op;
	scoreText.alpha = 1-op;
	scoreMeText.alpha = 1-op;
	hpText.alpha = 1-op;
	o2Text.alpha = 1-op;
	highScoreText.alpha = op;
	chatText.alpha = (1-op) * (CHATACTIVE?0.75:0.25);
	chatMeText.alpha = (1-op) * (CHATACTIVE?0.75:0.25);
	if (diedText.alpha>0) diedText.alpha -= 0.05;
	for (i=0;i<FISH.length;i++) {
		displayNames[i].alpha = 1-op;
	}
}
</script>
	<style>
	body {
		background-color: #4477bb;
		width: 100%;
		padding: 0px;
		margin: 0px;
		position: fixed;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}
	canvas {
		background-color: transparent;
		z-index: -1;
	}
	input:focus, button:focus{
		outline: none;
	}
	.cs{
		width: 14px;
		height: 14px;
		margin: 3px;
		float: left;
		border-radius: 3px;
		padding: 3px;
		box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-webkit-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-moz-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		transition: width 0.3s, height 0.3s, margin 0.3s;
	}
	.cs:hover{
		width: 24px;
		height: 24px;
		margin: -2px;
		cursor: pointer;
	}
	.csH{
		padding: 0px;
		border: 3px white solid;
	}
	.csH:hover{
		border: 3px white solid;
	}
	#container
	{
		width: 1000px;
		margin-left: auto;
		margin-right: auto;
	}
	button,input,select{
		border: 1px black solid;
		height: 40px;
		font-size: 20px;
		box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-webkit-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
		-moz-box-shadow: 0 3px 5px rgba(0,0,0,0.5);
	}
	input{
		padding-top: 3px;
		border-radius: 20px 0 0 20px;
		text-indent: 15px;
		font-family: lucida console;
	}
	#playBtn {
		background-color: #59f;
		font-size: 24px;
		border-radius: 0 20px 20px 0;
		margin-left: -4px;
		width: 70px;
		font-family: "Baloo";
		color: white;
		transition: all 0.15s;
	}
	#playBtn:hover{
		background-color: #6Bf;
	}
	a{
		color: lightBlue;
	}
	.textShadow{
		text-shadow:
			0px -1px 0 rgba(255,255,255,0.7),
			-1px 1px 0 rgba(0,0,0,0.6),
			1px 1px 0 rgba(0,0,0,0.6);
	}
	font{
		color: #3b3;
		position: relative;
	}
	#f1,#f2,#f3,#f6,#f7,#f8{
		margin-right: -8px;
	}
</style>
	<script src="socket.io/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.0.0/pixi.min.js"></script>
  </head>
	<body onload="init();" onresize='resize();'>
		<div align="center">
			<canvas id="game-canvas" width="1000" height="600"></canvas>
			<div id=lol style="padding-top: 40px;background-color:transparent;position:absolute;opacity:1">
				<div id=menu style="padding: 20px; height: 400px; width: 320px; margin-top: 20%;">
					<div style="font-family: Baloo; font-size: 50px; text-align: center;width: 100%; font-weight: bold;" class="textShadow">
						<font id = "f1">T</font>
						<font id = "f2">i</font>
						<font id = "f3">m</font>
						<font id = "f4">e</font>
						<font id = "f5">2</font>
						<font id = "f6">S</font>
						<font id = "f7">w</font>
						<font id = "f8">i</font>
						<font id = "f9">m</font>
					</div>
					<br><br>
					<input type=text id=nickname maxlength=18 autofocus/>
					<button class="textShadow" id=playBtn onclick="startSocket();">Play</button>
					<div id="conn" style="margin-top:5px; visibility: hidden">Connecting...</div>
					<div id=customize style="margin-top: 250px; width: 320px;">
						<div class=cs style="background-color: #f00"></div>
						<div class=cs style="background-color: #ff8000"></div>
						<div class=cs style="background-color: #ff0"></div>
						<div class=cs style="background-color: #80ff00"></div>
						<div class=cs style="background-color: #0f0"></div>
						<div class=cs style="background-color: #00ff80"></div>
						<div class=cs style="background-color: #0ff"></div>
						<div class=cs style="background-color: #007fff"></div>
						<div class=cs style="background-color: #00f"></div>
						<div class=cs style="background-color: #7f00ff"></div>
						<div class=cs style="background-color: #f0f"></div>
						<div class=cs style="background-color: #ff0080"></div>
					</div>
					<div style="clear: both"></div>
				</div>
			</div>
			<canvas id="canvasText" width="0" height="0"></canvas>
			<audio src="htdocs/bubble.wav" type="audio/wav" id="bubble">
		</div>
		<script>
		var node = document.getElementById('nickname');
		node.addEventListener('keydown', function onEvent(event) {
			if (event.key === "Enter" && MOUSEX>=0 && MOUSEX<=WIDTH) {
				startSocket();
			}
		});
		
		var COLOR = {r:255,g:0,b:0};
		var MYTYPE = 1+Math.floor(2.99*Math.random());
		
		function heh(col){
			var el = document.getElementsByClassName("csH")[0];
			if (el) el.className = "cs";
			var arel = document.getElementsByClassName("cs");
			for (i=0;i<arel.length;i++){
				if(arel[i].style.backgroundColor != col) continue;
				arel[i].className = "cs csH";
				col = col.substr(4);
				var iu = col.indexOf(',');
				COLOR.r = Math.round(col.substr(0,iu));
				col = col.substr(iu+2);
				iu = col.indexOf(',');
				COLOR.g = Math.round(col.substr(0,iu));
				col = col.substr(iu+2);
				iu = col.indexOf(')');
				COLOR.b = Math.round(col.substr(0,iu));
				setF();
			};
		};
		var arel = document.getElementsByClassName("cs");
		for(i = 0;i < arel.length; i++){
			var col = arel[i].style.backgroundColor;
			arel[i].onclick = new Function("heh('" + col + "');bubbleSnd.play();");
		};
		var ele = document.getElementById("lol");
		
		var letters = [];
		for (i=0;i<9;i++) {
			letters[i] = document.getElementById("f"+(i+1));
		}
		</script>
		<script>
var CANVAS, C, WIDTH, HEIGHT;
var SCROLLX, SCROLLY;
var MOUSEX, MOUSEY, LMB;
var PLANKTON = [];
var TIME = 0;

var boatX = 0;
var boatXTo = 0;
var boatY = 0;
var boatVX = 0;
var boatVA = 0;
var boatTargetX = 0;
//var boatWaitTarget = 0;
//var boatStop = false;
var rodUp = 0;
var hookXTo = 0;
var hookYTo = 0;
var hookX = 0;
var hookY = 0;
var hookVX = 0;
var hookVY = 0;
var veinLen = 0;

var PLAYERID = -1;

var BOTTOM = [], BOTTOMSIZE = 50;
/*	[2200,150,500,2,Math.PI,[255,0,100],0,0,"",100,100],
	[2300,200,1,2,1,[0,255,100],0,0,"",100,100],
];*/
var FISH = []; // px,py,size,vel,dir,color,targetDir,boost,nick,hp,stamina
var POSTO = [];
var SHARK = []; // px,py,size,vel,dir,targetDir
var SHARKTO = [];
var BOUNDRIGHT = 7000;

for (i=0;i<10;i++)
{
	FISH.push([0,0,0,0,0,0,0,0,"",0,0,0]);
	POSTO.push([0,0,0,0,0]);
	SHARK.push([0,0,0,0,0,0]);
	SHARKTO.push([0,0,0,0,0]);
}

var type = 1;

var renderer;

var highScore = 0;
var hpText, o2Text, scoreText, scoreMeText, diedText, highScoreText, scoreStyle, chatText, chatMeText;
var HPsmooth = 0;
var O2smooth = 0;

var displayNames = [];

var skywater;

//var points = []; of fish mesh rope

var canvas,contextText;

var bubbleSnd;

function RELOAD()
{
	alert("You've been kicked, you were inactive or the connection was broken.");
	location.reload();
	setTimeout(null,100000);
}

function resize() {	
    WIDTH = window.innerWidth;
    HEIGHT = window.innerHeight;
	
	if (WIDTH<640) WIDTH = 640;
	if (WIDTH>1600) WIDTH = 1600;
	if (HEIGHT<480) HEIGHT = 480;
	if (HEIGHT>1000) HEIGHT = 1000;
	
	canvas.width = WIDTH;
	canvas.height = HEIGHT;
	
	this.renderer.resize(WIDTH, HEIGHT);
	
	scoreMeText.x = WIDTH-120;
	scoreText.x = WIDTH-120;
	
	chatText.x = chatMeText.x = 0.07*WIDTH;
	chatText.y = chatMeText.y = HEIGHT-100;
	
	var conq = canvas.getBoundingClientRect();
	
	ele.style.left = Math.round(WIDTH/2-173)+conq.left+"px";
	ele.style.top = Math.round(HEIGHT/2-350)+"px";
	
	skywater.width = WIDTH;
	
	diedText.x = WIDTH/2;
	diedText.y = HEIGHT/2-150;
	
	highScoreText.x = WIDTH/2;
	highScoreText.y = HEIGHT/2+150;
}
function init() {
	stage = new PIXI.Container();
	
	canvas = document.getElementById("game-canvas");
	contextText = document.getElementById("canvasText").getContext('2d');
	
	renderer = PIXI.autoDetectRenderer(WIDTH,HEIGHT,{view:canvas,antialias:true});
	
	window.addEventListener("mousedown", mouseDown);
	window.addEventListener("mouseup", mouseUp);
	window.addEventListener("keydown", keyDown);
	
	bubbleSnd = document.getElementById('bubble');
	
	skywater = new PIXI.Sprite(PIXI.Texture.fromImage("htdocs/skywater.png"));
	skywater.position.x = 0;
	skywater.position.y = 0;
	skywater.width = WIDTH;
	skywater.height = 3000;//HEIGHT?;
	
	boat = new PIXI.Sprite(PIXI.Texture.fromImage("htdocs/boat.png"));
	boat.anchor.set(0.5,0.5);
	
	man = new PIXI.Sprite(PIXI.Texture.fromImage("htdocs/man.png"));
	man.anchor.set(-0.3,1.2);
	man.scale.x = -1;
	
	C = new PIXI.Graphics();
	
	hpText = new PIXI.Text('HP', {
        fontSize: 20,
        fontFamily: 'Lucida Console',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#888888',
        strokeThickness: 3
    });
	hpText.x = 30;
	hpText.y = 29;
	hpText.alpha = 0;
	
	o2Text = new PIXI.Text('O₂', {
        fontSize: 20,
        fontFamily: 'Lucida Console',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#888888',
        strokeThickness: 3
    });
	o2Text.x = 30;
	o2Text.y = 64;
	o2Text.alpha = 0;
	
	contextText.font = "18px Baloo";

	scoreStyle = new PIXI.TextStyle({
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFFFF',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	
	scoreText = new PIXI.Text('SCORE: 1', scoreStyle);
	scoreText.y = 25;
	scoreText.anchor.set(0.5, 0);
	scoreText.alpha = 0;
	
	scoreMeText = new PIXI.Text('SCORE', {
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFF00',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	scoreMeText.y = 25;
	scoreMeText.anchor.set(0.5, 0);
	scoreMeText.alpha = 0;
	
	diedText = new PIXI.Text('You died', {
        fontSize: 48,
        fontFamily: 'Georgia',
        fill: '#FF0000',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	diedText.anchor.set(0.5, 0);
	diedText.alpha = 0;
	
	highScoreText = new PIXI.Text('', {
        fontSize: 28,
        fontFamily: 'Baloo',
        fill: '#FFFF88',
        align: 'center',
        stroke: '#000000',
        strokeThickness: 2,
    });
	highScoreText.anchor.set(0.5, 0);
	highScoreText.alpha = 0;
	
	chatText = new PIXI.Text('', {
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFFFF',
        align: 'left',
        stroke: '#000000',
        strokeThickness: 2,
    });
	chatText.anchor.set(0, 1);
	chatText.alpha = 0;
	
	chatMeText = new PIXI.Text('Press ENTER to chat', {
        fontSize: 18,
        fontFamily: 'Baloo',
        fill: '#FFFF88',
        align: 'left',
        stroke: '#000000',
        strokeThickness: 2
    });
	chatMeText.anchor.set(0, 0);
	chatMeText.alpha = 0;
	
	stage.addChild(skywater,man,boat,C,hpText,o2Text,scoreText,scoreMeText,diedText,highScoreText,chatText,chatMeText);
	
	for (i=0;i<FISH.length;i++) {
		displayNames[i] = new PIXI.Text('hey', {
			fontSize: 18,
			fontFamily: 'Baloo',
			fill: '#FFFFFF',
			align: 'center',
			stroke: '#000000',
			strokeThickness: 2,
		});
		displayNames[i].x = 300+70*i;
		displayNames[i].y = 250;
		displayNames[i].anchor.set(0.5, 0);
		displayNames[i].alpha = 0;;
		stage.addChild(displayNames[i]);
	}
	
	requestAnimationFrame(update);
	
	var col = arel[Math.floor((arel.length-0.01)*Math.random())].style.backgroundColor;
	heh(col);
	
	canvas.focus();
	node.focus();
		
	document.getElementById("lol").style.zIndex = 1;
	canvas.style.zIndex = -1;
	document.getElementById("lol").style.position = "absolute";
	
	resize();
}

var WIDTH = 1000;
var HEIGHT = 600;
var SCROLLX = 600;
var SCROLLY = -200;
var TIME = 0;

var gameStarted = false;
var justStarted = false;
var getSmaller = 1;
function startGame()
{
	randomizeBottom();
	randomizePlankton();
	
	levelAlert = 0;
	
	MOUSEX = 0;
	MOUSEY = 0;
	
	HPsmooth = 100;
	O2smooth = 100;
	
	deltaTime = 1;
	justStarted = true;
	gameStarted = true;
	getSmaller = 1;
	
	totalLines = 0;
	chatText.text = "";
	chatMeText.text = "Press ENTER to chat";
	CHATACTIVE = false;
	
	boatX = 2000;
	boatY = 5;
	boatVX = 0;
	boatVA = 0;
	boatTargetX = 3000;
	//boatStop = true;
	
	man.scale.x = (boatVX>0?-1:1);
	
	fadeOutMenu();
	//loop();
	canvas.focus();
}

function getSize(s)
{
	return 0.7*Math.pow(s,0.35);
}

var lastTime = 0;
var levelAlert = 0;
var deltaTime = 1;
var SOFT = 0;
var lastUpdate = 0;
function update(time)
{
	TIME = time/15;
	
    if (lastTime) {
        deltaTime = deltaTime*0.5+(time - lastTime)/33.4;
		if (deltaTime>3) deltaTime = 3;
    }
    lastTime = time;
	
	C.clear();
	
	input();
	
	if (gameStarted)
	{
		if (justStarted)
		{
			SCROLLX = POSTO[PLAYERID][0]-WIDTH/2;
			SCROLLY = POSTO[PLAYERID][1]-HEIGHT/2-65;
			SOFT = 0;
			justStarted = false;
			lastUpdate = TIME;
		}
		else
		{
			SOFT = Math.pow(0.9,deltaTime);
			control();
			
			if (POSTO[PLAYERID][0]==0 || TIME-lastUpdate>300)
			{
				RELOAD();
			}
		}
		
		skywater.y = -1180-SCROLLY;
		
		renderPlankton();
		moveBoat();
		
		var len = 270 + 80 * Math.sin(TIME*0.01);
		var shift = 150 + 80 * Math.sin(TIME*0.003427);
		
		for (i=0;i<SHARK.length;i++)
		{
			if (!SHARK[i] || SHARKTO[i][0]==0) continue;
			
			var fish = SHARK[i];
			var vel = fish[3];
			var dir = fish[4];
			FX = fish[0];
			FY = fish[1];
			SIN = Math.sin(dir);
			COS = Math.cos(dir);
			SIZE = fish[2];
			VEL = fish[3];
			var mouthX = FX + COS*SIZE*18;
			var mouthY = FY + SIN*SIZE*18;
			
			SHARK[i][0] = (FX + vel*COS*deltaTime) * SOFT + SHARKTO[i][0] * (1-SOFT);
			SHARK[i][1] = (FY + vel*SIN*deltaTime) * SOFT + SHARKTO[i][1] * (1-SOFT);
			SHARK[i][3] = VEL * SOFT + SHARKTO[i][2] * (1-SOFT);
			SHARK[i][4] = dir * SOFT + SHARKTO[i][3] * (1-SOFT);
			SHARK[i][5] = SHARK[i][5] * SOFT + SHARKTO[i][4] * (1-SOFT);
			
			var followClosest = 10000000;
			
			for (a=0;a<FISH.length;a++)
			{
				if (!FISH[i] || !POSTO[i] || POSTO[i][0]==0) continue;
			
				var dx = FISH[a][0]-mouthX;
				var dy = FISH[a][1]-mouthY;
				var dist = dis(dx,dy);
				var s2 = getSize(FISH[a][2]);
				
				if (FY>30 && dist<60000)
				{
					if (dist < followClosest)
					{
						followClosest = dist
						SHARK[i][5] = Math.atan2(dy,dx);
					}
				}
				
				if (dist<Math.pow(SIZE*2+s2,2)*25)
				{
					FISH[a][9] -= 3/(2+s2)*deltaTime;
				}
			}
			
			if (FY > SIZE * 5.9)
			{
				var turn = (mod(SHARK[i][5]+Math.PI-dir,2*Math.PI)-Math.PI);
				if (turn>1) turn = 1;
				if (turn<-1) turn = -1;
				
				SHARK[i][4] += deltaTime*turn/(10+10*SIZE);
			}
			
			var how = mod(FX/BOTTOMSIZE,1);
			var le = BOTTOM[Math.floor(FX/BOTTOMSIZE)];
			var ri = BOTTOM[Math.ceil(FX/BOTTOMSIZE)];
			var bottom = le*(1-how) + ri*how - SIZE * 6;
			if (FY > bottom)
			{
				var much = (FY - bottom)*0.3;
				SHARK[i][3] *= 1-0.01*much*deltaTime;
				SHARK[i][0] += much * (ri-le)/BOTTOMSIZE * deltaTime;
				SHARK[i][1] -= much * deltaTime;
				
				much = SIZE * 3 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					SHARK[i][4] += SIN * (COS<0?1:-1) * 0.02 * much * deltaTime;
					SHARK[i][3] *= 1 - 0.03*deltaTime;
				}
			}
			else if (FY < SIZE * 3)
			{
				much = SIZE * 3 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					SHARK[i][4] += much * (COS>0?0.01:-0.01)/(Math.abs(VEL)+0.1) * deltaTime;
					SHARK[i][3] += much * SIN * 0.025 * deltaTime;
				}
			}
			else SHARK[i][3] = SHARK[i][3]*(1-0.1*deltaTime) + 0.25*deltaTime;
			
			var mx = FX-SCROLLX;
			var my = FY-SCROLLY;
			if (mx>-25*SIZE && mx<WIDTH+25*SIZE && my>-25*SIZE && my<HEIGHT+25*SIZE) renderShark();
		}
		
		for (i=0;i<FISH.length;i++)
		{
			if (!FISH[i] || !POSTO[i] || POSTO[i][0]==0)
			{
				//alert(FISH.length+" hey");
				displayNames[i].y = -100;
				continue;
			}
			//else alert(FISH.length+" nope");
			
			var fish = FISH[i];
			var dir = fish[4];
			FX = fish[0];
			FY = fish[1];
			SIN = Math.sin(dir);
			COS = Math.cos(dir);
			SIZE = getSize(fish[2]);
			VEL = fish[3];
			col = fish[5];
			COLOR.b = col%256;
			col = (col - COLOR.b)/256;
			COLOR.g = col%256;
			col = (col - COLOR.g)/256;
			COLOR.r = col%256;
			FISH[i][0] = (FX + VEL*COS*deltaTime) * SOFT + POSTO[i][0] * (1-SOFT);
			FISH[i][1] = (FY + VEL*SIN*deltaTime) * SOFT + POSTO[i][1] * (1-SOFT);
			FISH[i][3] = VEL * SOFT + POSTO[i][2] * (1-SOFT);
			FISH[i][4] = dir * SOFT + POSTO[i][3] * (1-SOFT);
			FISH[i][2] = fish[2] * SOFT + POSTO[i][4] * (1-SOFT);
			
			var mouthX = FX + COS*SIZE*18;
			var mouthY = FY + SIN*SIZE*18;
			
			FISH[i][2] -= 0.00001*(SIZE-0.7)*(200-FISH[i][9]);
			
			if (getSmaller<0.99 && i==PLAYERID)
			{
				if (diedText.alpha<1) diedText.alpha += 0.05;
				SIZE*=getSmaller;
				getSmaller-=0.1;
				if (getSmaller<=0) continue;
			}
			
			for (a=0;a<PLANKTON.length;a++)
			{
				var px = PLANKTON[a][0];
				px += 5*Math.sin(px*0.01+TIME*0.05);
				if (dis(px-mouthX,PLANKTON[a][1]-mouthY) < SIZE*SIZE*250+20)
				{
					socket.emit("tasty",0.1);
					
					var x = Math.random()*(BOUNDRIGHT-2800)+1400;
					if (x-SCROLLX>-10 && x-SCROLLX<WIDTH+10)
					{
						if (SCROLLX<BOUNDRIGHT/2) x+=2500;
						else x-=2500;
					}
					
					var le = BOTTOM[Math.floor(x/BOTTOMSIZE)];
					var ri = BOTTOM[Math.ceil(x/BOTTOMSIZE)];
					if (le<ri) ri = le;
					
					var y = Math.random() * (ri-100) + 50;
					
					PLANKTON[a]=[x,y];
					//FISH[i][2] += 0.1;
				}
			}
			
			/*for (a=i+1;a<FISH.length;a++)
			{
				var s2 = 0.7*Math.pow(FISH[a][2],0.4);
				if (Math.pow(FISH[a][0]-FX,2)+Math.pow(FISH[a][1]-FY,2)<Math.pow(SIZE+s2,2)*100+50)
				{
					if (SIZE > s2)
					{
						FISH[i][2] += s2;
						FISH.splice(a,1);
					}
					else
					{
						FISH[a][2] += SIZE;
						FISH.splice(i,1);
						continue;
					}
				}
			}*/
			
			if (FY > SIZE * 5.9)
			{
				var turn = (mod(FISH[i][6]-dir,2*Math.PI)-Math.PI)*2.61/VEL;
				if (turn>1) turn = 1;
				if (turn<-1) turn = -1;
				
				FISH[i][4] += deltaTime*turn/(10+2*SIZE);
				
				if (FISH[i][7] && FISH[i][10]>0.5)
				{
					FISH[i][3] += 0.25;
					FISH[i][10] -= 0.5;
				}
			}
			FISH[i][10] += 0.1;
			if (FISH[i][10]>100) FISH[i][10] = 100;
			
			var how = mod(FX/BOTTOMSIZE,1);
			var le = BOTTOM[Math.floor(FX/BOTTOMSIZE)];
			var ri = BOTTOM[Math.ceil(FX/BOTTOMSIZE)];
			var bottom = le*(1-how) + ri*how - SIZE * 12;
			if (FY > bottom)
			{
				var much = (FY - bottom)*0.3;
				FISH[i][3] *= 1-0.01*much*deltaTime;
				FISH[i][0] += much * (ri-le)/BOTTOMSIZE * deltaTime;
				FISH[i][1] -= much * deltaTime;
				
				much = SIZE * 6 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					FISH[i][4] += SIN * (COS<0?1:-1) * 0.02 * much;
					FISH[i][3] *= 1 - 0.03*deltaTime;
					FISH[i][9] -= 0.5 * deltaTime;
				}
			}
			else if (FY < SIZE * 6)
			{
				much = SIZE * 6 - FY;
				if (much>0)
				{
					if (much>5) much = 5;
					FISH[i][4] += much * (COS>0?0.02:-0.02)/(Math.abs(VEL)+0.1) * deltaTime;
					FISH[i][3] += much * SIN * 0.025 * deltaTime;
					FISH[i][1] += 0.1;
				}
			}
			else FISH[i][3] = FISH[i][3]*0.9 + 0.25;
			
			if (FISH[i][9]<=0)
			{
				FISH[i][3] = 0;
				FISH[i][9] = 0;
			}
			else
			{
				FISH[i][9] += 0.03*deltaTime;
				if (FISH[i][9]>100) FISH[i][9] = 100;
			}
			
			var mx = FX-SCROLLX;
			var my = FY-SCROLLY;
			if (mx>-25*SIZE-20 && mx<WIDTH+25*SIZE+20)
			{
				if (my>-25*SIZE && my<HEIGHT+25*SIZE)
				{
					type = FISH[i][11];
					renderFish();
				}
				
				my = FY-SIZE*33-30-SCROLLY;
				if (my>-25*SIZE && my<HEIGHT+25*SIZE)
				{
					displayNames[i].x = mx;
					displayNames[i].y = my;
					displayNames[i].text = FISH[i][8];
				}
				else displayNames[i].y = -100;
			}
			else displayNames[i].y = -100;
			
			
			//FX = POSTO[i][0]; FY = POSTO[i][1];	renderFish();
			
			//for (p=0;p<20;p++) {renderFish();FX+=25;if (FX>SCROLLX+800) {FX = SCROLLX+200; FY+=25;}}
		}
		
		if (ele.style.opacity>0.05) setF();
		
		renderWater();
		renderBottom();
		renderGreenShit();
		
		face();
		
		sendPlayerData();
	}
	else
	{
		for (i=0;i<9;i++) {
			letters[i].style.top = Math.round(11*Math.sin(TIME*0.04+i*0.7))+"px";
		}
		setF();
	}
	
	renderer.render(stage);
	
    requestAnimationFrame(update);

	//setTimeout(update,1000/6000);
}

function moveBoat()
{
	hookX = hookX * 0.7 + hookXTo * 0.3;
	hookY = hookY * 0.7 + hookYTo * 0.3;
	
	var vx = Math.cos(TIME*0.07)*boatVX;
	var vy = Math.sin(TIME*0.07)*Math.abs(boatVX);
	
	var high = Math.atan(rodUp-6);
	
	var tox = boatX-man.scale.x*(65-(high+1.2)*(high+1.2)*2);
	var toy = boatY-50-20*high;
	
	if (veinLen==0)
	{
		hookX = tox;
		hookY = toy;
	}
	var hx = hookX-SCROLLX;
	var hy = hookY-SCROLLY;
	
	boatX = boatX * SOFT + boatXTo * (1-SOFT);
	
	if (Math.abs(boatX-boatTargetX)<100)
	{
		if (hookY>0 && veinLen>0)
		{			
			hookVY *=0.99;
			hookVX -= 0.05*man.scale.x;
			
			var vex = hookX-tox;
			var vey = hookY-toy;
			
			var len = Math.sqrt(vex*vex+vey*vey);
			var distance = veinLen-len;
			
			if (distance<0)
			{
				hookVX *=0.95;
				hookVY *=0.95;
				hookX += 0.05*vex/len*distance;
				hookY += 0.05*vey/len*distance;
			}
		}
		/*if (boatStop)
		{
			boatTargetX += 0.5*(1000+500*Math.random()) * (Math.floor(Math.random())*2-1); // 1000 - 1500 pixels left or right
			if (boatTargetX < 2200)  boatTargetX += 3000;
			if (boatTargetX > BOUNDRIGHT-2200)  boatTargetX -= 3000;
		}
		else
		{
			//boatWaitTarget = TIME+500;
			//boatStop = true;
		}*/
		
		/*if (rodUp<12 || TIME>boatWaitTarget)
		{			
			if (TIME<=boatWaitTarget)
			{
				hookX = tox;
				hookY = toy;
				veinLen = 340;
				hookVX = -man.scale.x*5;
				hookVY = 0;
				rodUp += 0.1*deltaTime;
			}
			else
			{
				if (veinLen>0) veinLen-=2;
				else
				{
					if (rodUp>0) rodUp -= 0.1*deltaTime;
					else rodUp = 0;						
				}
			}
			
		}
		else 
		{
			rodUp = 12;
			hookVY += 0.2;
			hookX += hookVX;
			hookY += hookVY;
		}
		
		if (veinLen>0)
		{
			if (hookY>0)
			{
				hookVY *=0.99;
				hookVX -= 0.05*man.scale.x;
			}
			
			var vex = hookX-tox;
			var vey = hookY-toy;
			
			var len = Math.sqrt(vex*vex+vey*vey);
			var distance = veinLen-len;
			
			if (distance<0)
			{
				hookVX *=0.95;
				hookVY *=0.95;
				hookX += 0.3*vex/len*distance;
				hookY += 0.3*vey/len*distance;
			}
		}*/
	}
	else
	{
		if (boatX<boatTargetX)
		{
			boatVX+=0.04;
		}
		else
		{
			boatVX-=0.04;
		}
	}
	if (boatVX>0)
	{
		if (man.scale.x>-1) man.scale.x -= 0.1;
	}
	else
	{
		if (man.scale.x<1) man.scale.x += 0.1;
	}
	
	boatVX *= 0.98;

	boatX += boatVX;
	boatVA += Math.sin(TIME*0.05)*0.0002 - Math.sin(boat.rotation) * 0.01 - boatVX * 0.0001;
	boatVA *= 0.9;
	
	man.x = boat.x = boatX - SCROLLX;
	man.y = boat.y = boatY - SCROLLY;
	boat.rotation += boatVA;
	
	C.lineStyle(9,0xd6ae77);
	C.moveTo(boat.x+16*man.scale.x,boat.y-23);
	C.lineTo(boat.x-vx*5,boat.y-30-vy*1.5);
	C.lineStyle(5,0x884400);
	C.lineTo(boat.x+vx*20,boat.y+vy*6);
	C.lineStyle(12,0x884400);
	C.lineTo(boat.x+vx*30,boat.y+10+vy*9);
	
	C.lineStyle(4,0x224422);
	C.moveTo(boat.x+man.scale.x*12,boat.y-25);
	C.lineTo(tox-SCROLLX,toy-SCROLLY);
	
	C.lineStyle(2,0x774422);
	C.lineTo(hx,hy);
	
	C.lineStyle(5,0xAAAAAA);
	if (man.scale.x>0) C.arc(hx, hy+20, 10, 0, 3.14);
	else C.arc(hx, hy+20, 10, 3.14, 0, true);
}

function compareNumbers(a, b) {
   return b[1] - a[1];
}

var listOnce = 0;
function face()
{
	//chatText.text = "meoemowemfowemfwoergm\ngenrgoerigneorginergerg\nWEWFWEF\gerge\n\negrergerg\n:P:P:P:P:P:P";

	HPsmooth = HPsmooth*0.8 + FISH[PLAYERID][9]*0.2;
	O2smooth = O2smooth*0.8 + FISH[PLAYERID][10]*0.2;
	
	C.lineStyle(2, 0x440000);
	C.beginFill(0x880000, 0.6);
	C.drawRoundedRect(25, 27, 120, 26, 10);
	C.endFill();
	
	if (HPsmooth>0.1)
	{
		var edge = 10;
		if (0.6*HPsmooth<10) edge = 0.6*HPsmooth;
		C.lineStyle(null);
		C.beginFill(0xFF0000, 0.6);
		C.drawRoundedRect(25, 32-edge*0.5, 1.2*HPsmooth, 16+edge, edge);
		C.endFill();
	}
	
	C.lineStyle(2, 0x225588);
	C.beginFill(0x3366AA, 0.6);
	C.drawRoundedRect(25, 62, 120, 26, 10);
	C.endFill();
	
	if (O2smooth>0.1)
	{
		var edge = 10;
		if (0.6*O2smooth<10) edge = 0.6*O2smooth;
		C.lineStyle(null);
		C.beginFill(0x55BBFF, 0.6);
		C.drawRoundedRect(25, 67-edge*0.5, 1.2*O2smooth, 16+edge, edge);
		C.endFill();
	}
	
	C.beginFill(0x000000,0.3);
	C.drawRoundedRect(WIDTH-230,15,220,250,10);
	C.endFill();
	
	if (listOnce > 100)
	{
		listOnce = 0;
	}
	else
	{
		listOnce++;
	
		var list = [];
		/*list.push(["maja",17]);
		list.push(["maja",17]);
		list.push(["dupaafsjdlrtk5mab6",15]);
		list.push(["gdspa",12]);
		list.push(["dupa2",10]);
		list.push(["dupa4",9]);
		list.push(["dupa5",11]);
		list.push(["dupa5",14]);
		list.push(["heniek1234",13]);*/
		for (i=0;i<FISH.length;i++)
		{
			if (POSTO[i][0] == 0) continue;
			
			var currSc = Math.round(FISH[i][2] * 10);
			if (i==PLAYERID)
			{
				if (currSc > highScore) highScore = currSc;
				currSc += 0.5;
			}
			if (currSc>0) list.push([FISH[i][8],currSc]);
		}
		list.sort(compareNumbers);
		
		var name = FISH[PLAYERID][8];
		
		var nr = 0;
		for (i=0;i<list.length;i++)
		{
			if (list[i][0] == name)
			{
				nr = i;
				break;
			}
		}
		
		var a = 9;
		
		var print = "⁌LEADERBOARD⁍";
		var print2 = "";
		for (i=0;i<list.length && i<a;i++)
		{
			if (nr>=a && i==a-2)
			{
				print += "\n...";
				print += "\n" + (nr+1) + ". " + name + " - " + Math.floor(list[nr][1]);
				print2 += "\n\n" + (nr+1) + ". " + name + " - " + Math.floor(list[nr][1]);
				break;
			}
			else
			{
				var left = (i+1) + ". " + list[i][0];
				var right = " - " + Math.floor(list[i][1]);
				
				var ri = contextText.measureText(right).width;
				var le = contextText.measureText(left).width;
				while (le + ri > 200 && left.length>5)
				{
					left = left.substr(0,left.length-1);
					le = contextText.measureText(left).width;
				}
				
				if (list[i][0] == name) print2 += "\n" + left + right;
				else print2 += "\n";
				print += "\n" + left + right;
			}
		}
		if (a<list.length && list.length>nr) print += "\n...";
		scoreText.text = print;
		scoreMeText.text = print2;
	}
}

function rgbToHex(r, g, b) {
    return "0x"+(((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1));
}

function renderFish()
{
	var colorOut = rgbToHex(Math.round(COLOR.r*0.8),Math.round(COLOR.g*0.8),Math.round(COLOR.b*0.8));
	var colorIn = rgbToHex(COLOR.r,COLOR.g,COLOR.b);
	
	var tirl = VEL*0.8*Math.cos(0.15*TIME);
	var twirl = VEL*1.5*Math.sin(0.15*TIME);
	var yummy = 3.5*Math.sin(0.1*TIME);
	
	if (ele.style.opacity > 0)
	{
		yummy = 0;
		
		if (COLOR.r+COLOR.g+COLOR.b == 157)
		{
			C.lineStyle(null);
			C.beginFill(0x006699,Math.round(ele.style.opacity*10)/10);
			C.drawRect(0,0,WIDTH,HEIGHT);
			C.endFill();
		}
	}
	
	C.lineStyle(null);
	C.beginFill(colorOut);
	
	if (type == 1)
	{
		swirlRot2(18,twirl*0.5,true);
		swirlRot2(31-0.2*twirl,-15-tirl);
		swirlRot2(29+0.2*twirl,15-tirl);
	}
	else if (type == 2)
	{
		swirlRot2(18,twirl*0.5,true);
		swirlRot2(29-0.2*twirl,-14-tirl);
		swirlRot2(33,0);
		swirlRot2(28+0.2*twirl,14-tirl);
	}
	else
	{
		swirlRot2(16,twirl*0.5,true);
		swirlRot2(33-0.2*twirl,-15-tirl);
		swirlRot2(27,3);
		swirlRot2(30+0.2*twirl,15-tirl);
	}
	
	C.closePath();
	C.endFill();
	
	C.beginFill(colorOut);
	
	if (type == 1)
	{
		swirlRot2(-8,-12,true);
		swirlRot2(-8,12);
		swirlRot2(9-0.5*tirl,21+0.5*twirl);
		swirlRot2(4,0);
		swirlRot2(8+0.5*tirl,-22+0.5*twirl);
	}
	else if (type == 2)
	{
		swirlRot2(-8,-17+0.15*twirl,true);
		swirlRot2(-12,0);
		swirlRot2(-8,17-0.15*twirl);
		swirlRot2(9-0.5*tirl,19+0.5*twirl);
		swirlRot2(4,0);
		swirlRot2(8+0.5*tirl,-19+0.5*twirl);
	}
	else
	{
		swirlRot2(-10,-12,true);
		swirlRot2(-12,0);
		swirlRot2(-10,12);
		swirlRot2(5-0.5*tirl,22+0.5*twirl);
		swirlRot2(18,0);
		swirlRot2(4+0.5*tirl,-22+0.5*twirl);
	}
	
	C.closePath();
	C.endFill();
	
	var pl = swirlPoint2(-24,1-tirl);
	var plmo = swirlPoint2(-24,6-yummy-tirl);
	var plmi = swirlPoint2(-10-type,3-tirl*0.5);
	var pr = swirlPoint2(24,twirl*0.5);
	var plu = swirlPoint2(-24+type*2,-24-twirl);
	var pld = swirlPoint2(-18+type*2,23-twirl);
	var pru = swirlPoint2(22-type*3,-18+twirl-type*2);
	var prd = swirlPoint2(15,19+twirl);
	var peye;
	if (type == 1) peye = swirlPoint2(-14,-7-twirl*0.25);
	else if (type == 2) peye = swirlPoint2(-11,-7-twirl*0.25);
	else peye = swirlPoint2(-13,-4-twirl*0.25);
	
	C.beginFill(colorIn)
	C.moveTo(pl[0],pl[1]);
	C.bezierCurveTo(plu[0],plu[1],pru[0],pru[1],pr[0],pr[1]);
	C.bezierCurveTo(prd[0],prd[1],pld[0],pld[1],plmo[0],plmo[1]);
	C.lineTo(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.lineStyle(SIZE*2.5,0xffffff);
	C.beginFill(0x000000);
	C.drawCircle(peye[0],peye[1],SIZE*(4.5-0.5*type));
	C.endFill();
}

function renderShark()
{
	C.lineStyle(null);
	C.beginFill(0x788F96);
	
	var tirl = VEL*0.5*Math.cos(0.15*TIME);
	var twirl = VEL*Math.sin(0.15*TIME);
	var yummy = 1.75*Math.sin(0.1*TIME);
	
	swirlRot2(18,twirl*0.5,true);
	swirlRot2(31-0.2*twirl,-7.5-tirl);
	swirlRot2(29+0.2*twirl,7.5-tirl);
	
	C.closePath();
	C.endFill();
	C.beginFill(0x788F96);
	
	swirlRot2(-21,-0.5,true);
	swirlRot2(9-0.5*tirl,10.5+0.5*twirl);
	swirlRot2(7,4);
	swirlRot2(8+0.5*tirl,-11+0.5*twirl);
	
	C.closePath();
	C.endFill();
		
	C.beginFill(0x89A4AD);
	
	var pl = swirlPoint2(-24,0.5-tirl);
	var plmo = swirlPoint2(-24,3-yummy-tirl);
	var plmi = swirlPoint2(-12,1.5-tirl*0.5);
	var pr = swirlPoint2(24,twirl*0.5);
	var plu = swirlPoint2(-20,-12-twirl);
	var pld = swirlPoint2(-20,9.5-twirl);
	var pru = swirlPoint2(20,-10+twirl);
	var prd = swirlPoint2(15,9+twirl);
	var peye = swirlPoint2(-14,-3.5-twirl*0.25);
	C.moveTo(pl[0],pl[1]);
	C.bezierCurveTo(plu[0],plu[1],pru[0],pru[1],pr[0],pr[1]);
	C.lineTo(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.beginFill(0xDDDDEE);
	C.moveTo(pr[0],pr[1]);
	C.bezierCurveTo(prd[0],prd[1],pld[0],pld[1],plmo[0],plmo[1]);
	C.lineTo(plmi[0],plmi[1]);
	C.closePath();
	C.endFill();
	
	C.beginFill(0x000000);
	C.lineStyle(SIZE*1.75,0xffffff);
	C.drawCircle(peye[0],peye[1],SIZE*2);
	C.endFill();
}

function swirlRot2(x,y,first)
{
	if (COS>0) y = -y;
	x*=SIZE;
	y*=SIZE;
	if (first) C.moveTo(FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY);
	else C.lineTo(FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY);
}

function swirlPoint2(x,y)
{
	if (COS>0) y = -y;
	x*=SIZE;
	y*=SIZE;
	return [FX-x*COS+y*SIN-SCROLLX,FY-y*COS-x*SIN-SCROLLY];
}

function control()
{
	var x = FISH[PLAYERID][0];
	var y = FISH[PLAYERID][1];
	//var x = POSTO[PLAYERID][0];
	//var y = POSTO[PLAYERID][1];
	
	//var SOFT = deltaTime*0.03;
	if (SOFT==0) return;
	
	//SOFT = 0.95;//(1-ele.style.opacity);
	
	SCROLLX = SCROLLX * SOFT + (0.5 * MOUSEX - 0.75 * WIDTH + x) * (1-SOFT);
	SCROLLY = SCROLLY * SOFT + (0.5 * MOUSEY - 0.75 * HEIGHT + y) * (1-SOFT);
	
	if (SCROLLX<0) SCROLLX = 0;
	if (SCROLLX>BOUNDRIGHT-WIDTH) SCROLLX = BOUNDRIGHT-WIDTH;
	
	FISH[PLAYERID][6] = -Math.PI/2-Math.atan2(MOUSEX+SCROLLX-x,MOUSEY+SCROLLY-y);
	FISH[PLAYERID][7] = LMB;
}

function renderBottom()
{
	C.lineStyle(2, 0x6E652B);
	C.beginFill(0x817639);
	
	C.moveTo(0,2*HEIGHT);
	
	for (x=0;x<WIDTH/BOTTOMSIZE+2;x++)
	{
		C.lineTo(x*BOTTOMSIZE-mod(SCROLLX,BOTTOMSIZE),BOTTOM[x+Math.floor(SCROLLX/BOTTOMSIZE)]-SCROLLY);
	}
	
	C.lineTo(WIDTH,2*HEIGHT);
	C.endFill();
}

function renderGreenShit()
{
	//C.beginFill(0x118833);
	
	for (x=0;x<WIDTH/BOTTOMSIZE+2;x++)
	{
		var which = x+Math.floor(SCROLLX/BOTTOMSIZE);
		var type = (2*which+which%11-which%5)%16;
		if (which<30 || which>BOUNDRIGHT/BOTTOMSIZE-30 || type>3) continue;
		
		var mx = x*BOTTOMSIZE-mod(SCROLLX,BOTTOMSIZE);
		var my = BOTTOM[which]-SCROLLY;
		
		if (type < 2)
		{
			var shift = TIME*0.05+(mx+SCROLLX)*0.01;
			C.lineStyle(5, 0x005522);
			C.moveTo(mx,my);
			var sy = my-20-which%7;
			var nd = mx+Math.sin(shift)*3;
			C.lineTo(nd,sy);
			C.lineTo(mx+Math.sin(shift+0.3)*7-(type==1?9:5)-which%3,sy-20-(which+3)%7);
			
			if (type == 1)
			{
				C.lineTo(nd,sy);
				C.lineTo(mx+Math.sin(shift)*7+2-(which+1)%2,sy-23-which%5);
			}
			
			C.lineTo(nd,sy);
			C.lineTo(mx+Math.sin(shift-0.3)*7+(type==1?14:10)-(which+2)%3,sy-20-which%7);
		}
		else if (type < 4)
		{
			C.beginFill(0x446677);
			//C.beginFill(0xAA3366);
			C.lineStyle(2, 0x335566);
			//C.lineStyle(5, 0x882244);
			w = 4+(which*3)%7;
			h = w-which%3;
			C.drawRoundedRect(mx-w,my-h*1.5,2*w,2*h,h-1);
			C.endFill();
		}
	}
	
	//C.endFill();
}

function input()
{
	if (getSmaller<0.99) return;
	var mousePosition = renderer.plugins.interaction.mouse.global;
	MOUSEX = mousePosition.x;
	MOUSEY = mousePosition.y;
}

function mouseDown(e)
{
	if (e.button == 0) LMB = true;
}

function mouseUp(e)
{
	if (e.button == 0) LMB = false;
}

var CHATACTIVE = false;
function keyDown(e)
{
	if (!gameStarted) return;
	
	var keyCode = e.which || e.keyCode || 0;
	var len = chatMeText.text.length;
	if (keyCode == 8)
	{
		if (len>4) chatMeText.text = chatMeText.text.substr(0,len-1);
	}
	else if (keyCode == 13)
	{
		if (CHATACTIVE)
		{
			chatText.alpha = 0.25;
			chatMeText.alpha = 0.25;
			CHATACTIVE = false;
			
			if (chatMeText.text.length>4)
			{
				socket.emit("chat",chatMeText.text.substr(4));
			}
			chatMeText.text = "Press ENTER to chat";
		}
		else
		{
			chatText.alpha = 0.75;
			chatMeText.alpha = 0.75;
			CHATACTIVE = true;
			
			chatMeText.text = "Me: ";
		}
	}
	else if (CHATACTIVE && keyCode>=32 && e.key.length == 1 && e.keyCode!=220 && len<70)
	{
		chatMeText.text += e.key;
	}
}

function dis(dx,dy)
{
	return dx*dx+dy*dy;
}

function squared(n)
{
	return n*n;
}

function renderWater()
{
	C.lineStyle(3, 0xFFFFFF, 0.1);
	C.beginFill(0x006699, 0.4);
	
	C.moveTo(0,HEIGHT);
	
	for (x=-2;x<WIDTH+15;x+=15)
	{
		C.lineTo(x,2*Math.sin(0.1*(x+SCROLLX+TIME))-SCROLLY);
	}
	C.lineTo(WIDTH,HEIGHT);
	C.endFill();
}

function randomizeBottom()
{
	BOTTOM = [];
	MAPWIDTH = 250;
	MAPHEIGHT = 100;
	
	BOTTOM = [Math.random()-0.5];
	
	var vel = 0;
	for (x=1;x<BOUNDRIGHT/BOTTOMSIZE+2;x++)
	{
		vel = 0.99*vel + pseudoRandom(x);
		BOTTOM.push((BOTTOM[x-1] + vel) * 0.5);
	}
	
	for (x=0;x<BOTTOM.length;x++)
	{
		BOTTOM[x] = (BOTTOM[x]*20+350)*(Math.atan((x*BOTTOMSIZE-1500)/200)-Math.atan((x*BOTTOMSIZE+1500-BOUNDRIGHT)/200))-80;
	}
}

function pseudoRandom(i)
{
	return Math.abs(23*Math.sin(BOTTOMKEY*i+273*i)+23*Math.tan(BOTTOMKEY*i*(0.2-3*i)))%1-0.5;
}

function randomizePlankton()
{
	PLANKTON = [];
	
	for (x=1400;x<BOUNDRIGHT-1400;x+=150)
	{
		var le = BOTTOM[Math.floor(x/BOTTOMSIZE)];
		var ri = BOTTOM[Math.ceil(x/BOTTOMSIZE)];
		if (le<ri) ri = le;
		
		var y = Math.random() * (ri-100) + 50;
		
		PLANKTON.push([x+Math.random()*20-10,y+Math.random()*20-10]);
	}
}

function renderPlankton()
{
	C.lineStyle(2, 0x227744);
	C.beginFill(0x339955);
	for (i=0;i<PLANKTON.length;i++)
	{
		var px = PLANKTON[i][0];
		px += 5*Math.sin(px*0.01+TIME*0.05);
		var mx = px-SCROLLX;
		var my = PLANKTON[i][1]-SCROLLY;
		if (mx>-10 && mx<WIDTH+10 && my>-10 && my<HEIGHT+10)
			C.drawCircle(mx,my,6+i%3);
	}
	C.endFill();
}


function mod(a,b)
{
	return (a%b+b)%b;
}

var sendOnce = 0;
function sendPlayerData()
{
	sendOnce++;
	if (sendOnce<2) return;
	sendOnce = 0;
	//px,py,size,vel,dir,color,targetDir,boost,nick,hp,stamina
	socket.emit('position',FISH[PLAYERID][6],FISH[PLAYERID][7]);
}

var canPlay = true;
var totalLines = 0;
function startSocket()
{
	if (!canPlay) return;
	canPlay = false;
	
	bubbleSnd.play();

	window.socket = io();
	
	document.getElementById('conn').style.visibility = 'visible'
	document.getElementById('conn').innerHTML = "Connecting...";
	
	socket.emit('accessToken',{color: COLOR.r * 65536 + COLOR.g * 256 + COLOR.b, nickname: node.value, type: MYTYPE});
	
	socket.on('noSlots',function(){
		document.getElementById('conn').innerHTML = "No slots available, we will add more rooms soon";
	});
	
	socket.on('chat',function(mess){
		if (gameStarted)
		{
			console.log(chatText.text.indexOf("\n"));
			chatText.text += "\n" + mess;
			if (totalLines>12) chatText.text = chatText.text.substr(chatText.text.indexOf("\n")+1);
			else totalLines++;
		}
	});
	
	socket.on('playerAdded',function(key,bound,id){
		BOTTOMKEY = key;
		BOUNDRIGHT = bound;
		PLAYERID = id;
		setTimeout(function(){waitForFirstPosition(true);},1000);
	});

	socket.on('died',function(){
		getSmaller = 0.9;
		setTimeout(fadeInMenu,1500);
	});
	
	var atmost = 0;
	function waitForFirstPosition(first)
	{
		if (first) atmost = 0;
		atmost++;
		if (atmost>15)
		{
			RELOAD();
		}
		if (POSTO[PLAYERID][0]!=0) startGame();
		else setTimeout(function(){waitForFirstPosition(false);},500);
	}
	
	socket.on('updatePlayers',function(fis,sha,boa,delay){
		lastUpdate = TIME;
		var d = new Date();
		var timeAhead = mod(1000*d.getSeconds()+d.getMilliseconds()-delay,60)/16.67;
		//FISH = fis.data;
		//alert(fis.data[0][0].length);
		for (i=0;i<10;i++) // why 10???
		{
			if (!fis.data[i]) continue;
			POSTO[i][4] = fis.data[i][2];
			var vel = fis.data[i][3];
			POSTO[i][2] = vel;
			var dir = fis.data[i][4];
			POSTO[i][3] = dir;
			FISH[i][5] = fis.data[i][5];
			FISH[i][6] = fis.data[i][6];
			FISH[i][7] = fis.data[i][7];
			FISH[i][9] = fis.data[i][9];
			FISH[i][10] = fis.data[i][10];
			FISH[i][11] = fis.data[i][11];
			
			POSTO[i][0] = fis.data[i][0]+Math.cos(dir)*timeAhead*vel;
			POSTO[i][1] = fis.data[i][1]+Math.sin(dir)*timeAhead*vel;
			
			if (FISH[i][8] != fis.data[i][8]) // new fish in - different name
			{				
				FISH[i][0] = POSTO[i][0];
				FISH[i][1] = POSTO[i][1];
				FISH[i][3] = POSTO[i][2];
				FISH[i][3] = POSTO[i][3];
				FISH[i][2] = POSTO[i][4];
				
				FISH[i][8] = fis.data[i][8];
			}
		}
		
		for (i=0;i<5;i++) // why 10???
		{
			if (!sha.data[i]) continue;
			SHARK[i][2] = sha.data[i][2];
			var vel = sha.data[i][3];
			SHARKTO[i][2] = vel;
			var dir = sha.data[i][4];
			SHARKTO[i][3] = dir;
			SHARKTO[i][4] = sha.data[i][5];
			
			SHARKTO[i][0] = sha.data[i][0]+Math.cos(dir)*timeAhead*vel;
			SHARKTO[i][1] = sha.data[i][1]+Math.sin(dir)*timeAhead*vel;
		}
		
		boatVX = boa.vx;
		boatXTo = boa.x+boatVX*timeAhead;
		boatTargetX = boa.tx;
		//boatWaitTarget = boa.wt;
		//boatStop = boa.s;
		rodUp = boa.ru;
		hookVX = boa.hvx;
		hookVY = boa.hvy;
		hookXTo = boa.hx+hookVX*timeAhead;
		hookYTo = boa.hy+hookVY*timeAhead;
		veinLen = boa.vl;
	});
}
		</script>
	</body>
</html>